# 准备测试用例

Drun 支持两种方式准备测试用例：手工编写和格式转换。

## 手工编写

### YAML 用例结构

```yaml
config:                    # 用例配置（必需）
  name: 用例名称
  base_url: https://api.example.com
  tags: [smoke, api]
  variables:
    key: value
  headers:
    User-Agent: Drun-Test
  timeout: 30.0

steps:                     # 测试步骤（必需）
  - name: 步骤名称
    request:
      method: POST
      path: /api/endpoint
      headers:
        Content-Type: application/json
      body:
        key: value
    extract:
      varName: $.data.field
    validate:
      - eq: [status_code, 200]
```

### config 配置项

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `name` | string | 是 | 用例名称 |
| `base_url` | string | 否 | 基础 URL |
| `tags` | list | 否 | 标签列表 |
| `variables` | dict | 否 | 全局变量 |
| `headers` | dict | 否 | 全局请求头 |
| `timeout` | float | 否 | 超时时间（秒） |
| `parameters` | list | 否 | 参数化配置 |

### request 请求配置

| 字段 | 类型 | 说明 |
|------|------|------|
| `method` | string | HTTP 方法：GET/POST/PUT/DELETE/PATCH |
| `path` | string | 请求路径（相对或绝对 URL） |
| `url` | string | 完整 URL（可替代 path） |
| `headers` | dict | 请求头 |
| `params` | dict | URL 查询参数 |
| `body` | any | JSON 请求体 |
| `data` | dict/string | Form 表单数据 |
| `files` | dict | 文件上传 |
| `auth` | dict | 认证配置 |
| `timeout` | float | 单步超时 |
| `stream` | bool | 流式响应 |

### 请求示例

#### GET 请求

```yaml
- name: 获取用户列表
  request:
    method: GET
    path: /api/users
    params:
      page: 1
      size: 10
    headers:
      Authorization: Bearer $token
```

#### POST JSON

```yaml
- name: 创建用户
  request:
    method: POST
    path: /api/users
    headers:
      Content-Type: application/json
    body:
      username: testuser
      email: test@example.com
```

#### POST Form

```yaml
- name: 表单提交
  request:
    method: POST
    path: /api/form
    headers:
      Content-Type: application/x-www-form-urlencoded
    data:
      username: admin
      password: 123456
```

#### 文件上传

```yaml
- name: 上传头像
  request:
    method: POST
    path: /api/avatar
    files:
      avatar: ["data/avatar.jpg", "image/jpeg"]
```

#### 认证配置

```yaml
# Bearer Token
- name: 带认证请求
  request:
    method: GET
    path: /api/protected
    auth:
      type: bearer
      token: ${ENV(TOKEN)}

# Basic Auth
- name: Basic 认证
  request:
    method: GET
    path: /api/admin
    auth:
      type: basic
      username: admin
      password: ${ENV(PASSWORD)}
```

#### 流式响应（SSE）

```yaml
- name: 流式 AI 对话
  request:
    method: POST
    path: /v1/chat/completions
    body:
      model: gpt-3.5-turbo
      messages: [{role: user, content: Hello}]
      stream: true
    stream: true
    stream_timeout: 30
  extract:
    event_count: $.stream_summary.event_count
  validate:
    - eq: [status_code, 200]
    - gt: [$event_count, 0]
```

---

## 格式转换

### cURL 转换

```bash
# 准备 cURL 文件
# converts/login.curl
curl -X POST https://api.example.com/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "123456"}'

# 转换
drun convert converts/login.curl --outfile testcases/test_login.yaml
```

转换结果：

```yaml
config:
  name: Imported Case
  base_url: https://api.example.com

steps:
  - name: POST /login
    request:
      method: POST
      path: /login
      headers:
        Content-Type: application/json
      body:
        username: admin
        password: "123456"
    validate:
      - eq: [status_code, 200]
```

### Postman 转换

```bash
# 基本转换
drun convert collection.json --outfile testcases/from_postman.yaml

# 带环境文件
drun convert collection.json \
  --outfile testcases/from_postman.yaml \
  --postman-env environment.json

# 拆分为多文件 + 生成套件
drun convert collection.json \
  --split-output \
  --suite-out testsuites/from_postman.yaml \
  --placeholders
```

### HAR 转换

```bash
# 基本转换
drun convert recording.har --outfile testcases/from_har.yaml

# 过滤选项
drun convert recording.har \
  --outfile testcases/from_har.yaml \
  --exclude-static \     # 排除静态资源
  --only-2xx             # 仅保留成功请求
```

### OpenAPI 转换

```bash
# 基本转换
drun convert-openapi openapi.json --outfile testcases/from_openapi.yaml

# 按标签过滤
drun convert-openapi openapi.json \
  --outfile testcases/from_openapi.yaml \
  --tags users,orders

# 拆分 + 变量占位
drun convert-openapi openapi.json \
  --split-output \
  --placeholders
```

### 转换选项说明

| 选项 | 说明 |
|------|------|
| `--outfile FILE` | 输出文件路径 |
| `--into FILE` | 追加到已有文件 |
| `--split-output` | 每个请求生成独立文件 |
| `--suite-out FILE` | 生成套件文件 |
| `--redact HEADERS` | 脱敏指定请求头 |
| `--placeholders` | 敏感值替换为变量 |
| `--case-name NAME` | 指定用例名称 |
| `--base-url URL` | 覆盖 base_url |

### 脱敏与占位

```bash
# 脱敏：将敏感头替换为 ***
drun convert api.curl --outfile test.yaml --redact Authorization,Cookie

# 占位：提取为变量
drun convert api.curl --outfile test.yaml --placeholders
```

占位转换结果：

```yaml
config:
  name: Imported Case
  variables:
    token: eyJhbGciOiJIUzI1NiIs...

steps:
  - name: GET /api/users
    request:
      method: GET
      path: /api/users
      headers:
        Authorization: Bearer $token
```

## 用例编写最佳实践

### 1. 命名清晰

```yaml
# 好
config:
  name: 用户登录 - 正确密码

# 不好
config:
  name: test1
```

### 2. 使用标签

```yaml
config:
  tags: [smoke, auth, critical]
```

### 3. 变量复用

```yaml
config:
  variables:
    base_path: /api/v1

steps:
  - name: 接口1
    request:
      path: $base_path/users
  - name: 接口2
    request:
      path: $base_path/orders
```

### 4. 充分断言

```yaml
validate:
  - eq: [status_code, 200]
  - eq: [$.code, 0]
  - ne: [$.data, null]
  - contains: [$.message, success]
```

### 5. 提取关键数据

```yaml
extract:
  token: $.data.token
  userId: $.data.user.id
```
