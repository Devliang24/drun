# Drun 代码调试指南

## 一、VS Code 调试配置

### 1.1 创建 launch.json

在项目根目录创建 `.vscode/launch.json`:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Drun: 运行单个测试",
            "type": "debugpy",
            "request": "launch",
            "module": "drun.cli",
            "args": [
                "r",
                "test_login",
                "--env", "dev"
            ],
            "cwd": "${workspaceFolder}",
            "console": "integratedTerminal",
            "justMyCode": false
        },
        {
            "name": "Drun: 运行带标签过滤",
            "type": "debugpy",
            "request": "launch",
            "module": "drun.cli",
            "args": [
                "r",
                "testcases",
                "--env", "dev",
                "-k", "smoke"
            ],
            "cwd": "${workspaceFolder}",
            "console": "integratedTerminal",
            "justMyCode": false
        },
        {
            "name": "Drun: 调试模式 (DEBUG日志)",
            "type": "debugpy",
            "request": "launch",
            "module": "drun.cli",
            "args": [
                "r",
                "test_login",
                "--env", "dev",
                "--log-level", "DEBUG",
                "--reveal-secrets"
            ],
            "cwd": "${workspaceFolder}",
            "console": "integratedTerminal",
            "justMyCode": false
        },
        {
            "name": "Drun: 当前打开的测试文件",
            "type": "debugpy",
            "request": "launch",
            "module": "drun.cli",
            "args": [
                "r",
                "${relativeFile}",
                "--env", "dev"
            ],
            "cwd": "${workspaceFolder}",
            "console": "integratedTerminal",
            "justMyCode": false
        }
    ]
}
```

### 1.2 配置说明

| 字段 | 说明 |
|------|------|
| `type: "debugpy"` | 使用 Python 调试器 |
| `module: "drun.cli"` | 以模块方式运行 drun |
| `justMyCode: false` | 允许进入第三方库代码 |
| `console: "integratedTerminal"` | 使用集成终端显示输出 |

### 1.3 使用步骤

```
1. 打开 VS Code 调试面板 (Ctrl+Shift+D / Cmd+Shift+D)
2. 选择调试配置 (如 "Drun: 运行单个测试")
3. 在代码中设置断点 (点击行号左侧)
4. 按 F5 启动调试
```

## 二、常用断点位置

### 2.1 调试测试执行流程

```python
# 文件: drun/runner/runner.py
# 位置: run_case 方法开头

def run_case(self, case, global_vars, params, funcs, envmap, source):
    name = case.config.name or "Unnamed Case"
    t0 = time.perf_counter()
    # ← 在此设置断点，查看用例开始执行时的状态
    
    ...
    
    for step_idx, step in enumerate(case.steps, 1):
        # ← 在此设置断点，查看每个步骤开始执行时的状态
```

### 2.2 调试变量渲染

```python
# 文件: drun/templating/engine.py
# 位置: render_value 方法

def render_value(self, value, variables, functions=None, envmap=None):
    if isinstance(value, str):
        text = self._strip_escape_quotes(value)
        # ← 在此设置断点，查看渲染前的值和变量表
        
        ...
        
        return result  # ← 在此设置断点，查看渲染后的结果
```

### 2.3 调试 HTTP 请求

```python
# 文件: drun/engine/http.py
# 位置: request 方法

def request(self, req: Dict[str, Any]) -> Dict[str, Any]:
    # ← 在此设置断点，查看完整的请求参数
    
    response = self.client.request(...)
    
    # ← 在此设置断点，查看响应结果
    return {...}
```

### 2.4 调试断言

```python
# 文件: drun/runner/runner.py
# 位置: 断言循环

for v in step.validators:
    actual = self._resolve_check(check_str, resp_obj)
    expect_rendered = self._render(v.expect, variables, funcs, envmap)
    
    # ← 在此设置断点，查看断言的实际值和期望值
    passed, err = compare(v.comparator, actual, expect_rendered)
```

## 三、VS Code 调试技巧

### 3.1 条件断点

右键点击断点，选择 "编辑断点"，可以设置条件:

```python
# 只在特定步骤名称时中断
step.name == "用户登录"

# 只在断言失败时中断
not passed

# 只在特定状态码时中断
resp_obj.get("status_code") != 200
```

### 3.2 日志断点

不中断执行，只打印日志:

```python
# 右键断点 → 编辑断点 → 日志消息
# 输入: 步骤: {step.name}, 变量: {variables}
```

### 3.3 监视表达式

在调试时添加监视表达式:

```python
# 常用监视表达式
step.name                    # 当前步骤名
variables                    # 变量上下文
resp_obj.get("status_code")  # 响应状态码
resp_obj.get("body")         # 响应体
len(case.steps)              # 步骤总数
step_idx                     # 当前步骤索引
```

### 3.4 调用堆栈

调试时查看 "调用堆栈" 面板，可以看到完整的函数调用链:

```
run_case (runner.py:100)
  └── _run_impl (cli.py:500)
        └── run (cli.py:450)
```

## 四、调试示例

### 4.1 示例1: 变量渲染问题

**问题**: `${user_id}` 没有被替换

**调试步骤**:

1. 在 `templating/engine.py` 的 `render_value` 方法设置断点
2. 启动调试，运行测试
3. 检查 `variables` 字典中是否包含 `user_id`
4. 检查变量名大小写是否匹配

**VS Code 调试视图**:
```
变量:
├── value: "/users/${user_id}"
├── variables:
│   ├── USER_ID: "12345"     ← 注意: 大写
│   └── token: "abc..."
└── envmap:
    └── BASE_URL: "https://..."

问题原因: variables 中是 USER_ID (大写)，但模板中是 user_id (小写)
```

### 4.2 示例2: 断言失败问题

**问题**: `eq: [$.data.status, "success"]` 失败

**调试步骤**:

1. 在 `runner/runner.py` 断言循环处设置断点
2. 启动调试，运行测试
3. 检查 `actual` 和 `expect_rendered` 的值
4. 检查类型是否匹配

**VS Code 调试视图**:
```
变量:
├── check_str: "$.data.status"
├── v.comparator: "eq"
├── expect_rendered: "success"   (str)
├── actual: "SUCCESS"            (str)  ← 大小写不匹配!
└── passed: False

问题原因: 接口返回 "SUCCESS" (大写)，期望值是 "success" (小写)
解决方案: 使用 contains 断言或修正期望值
```

### 4.3 示例3: HTTP 请求 401 错误

**问题**: 请求返回 401 Unauthorized

**调试步骤**:

1. 在 `engine/http.py` 的 `request` 方法设置断点
2. 检查请求头中的 Authorization
3. 检查 token 是否正确传递

**VS Code 调试视图**:
```
变量:
├── req:
│   ├── method: "GET"
│   ├── path: "/api/users"
│   └── headers:
│       ├── Content-Type: "application/json"
│       └── Authorization: "Bearer "  ← 注意: token 为空!

问题原因: TOKEN 环境变量未设置或提取失败
检查: envmap.get("TOKEN") 或前一步骤的 extract
```

## 五、命令行调试选项

### 5.1 使用 --log-level DEBUG

```bash
drun r test_login --env dev --log-level DEBUG
```

输出详细日志，包括:
- 变量渲染前后对比
- 完整的请求/响应信息
- 断言执行详情

### 5.2 使用 --reveal-secrets

```bash
drun r test_login --env dev --reveal-secrets
```

显示敏感信息（默认会脱敏），便于调试:
- Authorization 头完整内容
- Token 值
- 密码等

### 5.3 使用 --response-headers

```bash
drun r test_login --env dev --response-headers
```

打印完整的响应头信息。

### 5.4 组合使用

```bash
drun r test_login --env dev \
    --log-level DEBUG \
    --reveal-secrets \
    --response-headers
```

## 六、常见问题排查

### 6.1 问题排查清单

| 问题 | 检查点 | 调试位置 |
|------|--------|----------|
| 变量未替换 | 变量名大小写、作用域 | templating/engine.py |
| 断言失败 | 实际值 vs 期望值、类型 | runner/runner.py |
| 401/403 错误 | Authorization 头、Token | engine/http.py |
| 连接超时 | base_url、网络 | engine/http.py |
| 用例未执行 | 标签过滤、文件发现 | loader/collector.py |
| Hook 未执行 | 函数名、语法 | loader/hooks.py |

### 6.2 日志分析

```bash
# 查看日志文件
cat logs/run-20251208-143000.log

# 搜索错误
grep -i "error\|fail" logs/run-*.log

# 搜索特定步骤
grep "用户登录" logs/run-*.log
```

## 七、VS Code 调试快捷键

| 快捷键 | 功能 |
|--------|------|
| `F5` | 开始/继续调试 |
| `F9` | 切换断点 |
| `F10` | 单步跳过 (Step Over) |
| `F11` | 单步进入 (Step Into) |
| `Shift+F11` | 单步跳出 (Step Out) |
| `Ctrl+Shift+F5` | 重启调试 |
| `Shift+F5` | 停止调试 |

## 八、推荐的 VS Code 插件

| 插件 | 作用 |
|------|------|
| Python | Python 语言支持 |
| Pylance | Python 智能提示 |
| Python Debugger | Python 调试器 |
| YAML | YAML 语法高亮 |
| GitLens | Git 增强 |
