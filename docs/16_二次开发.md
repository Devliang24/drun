# 二次开发

Drun 可以作为库导入使用，实现框架能力扩展和测试平台集成。

## 作为库使用

### 安装

```bash
pip install drun
```

### 基本用法

```python
from pathlib import Path
from drun.loader.yaml_loader import load_yaml_file
from drun.loader.env import load_environment
from drun.runner.runner import Runner
from drun.utils.logging import setup_logging, get_logger

# 配置日志
setup_logging("INFO")
log = get_logger("mytest")

# 加载环境变量
env_store = load_environment("dev", ".env.dev")

# 加载测试用例
cases, meta = load_yaml_file(Path("testcases/test_login.yaml"))

# 创建运行器
runner = Runner(
    log=log,
    failfast=False,
    reveal_secrets=True,
    persist_env_file=".env.dev"
)

# 执行测试
for case in cases:
    result = runner.run_case(
        case,
        global_vars={},
        params={},
        funcs={},
        envmap=env_store,
        source="testcases/test_login.yaml"
    )
    print(f"Case: {result.name}, Status: {result.status}")

# 生成报告
report = runner.build_report([result])
print(f"Total: {report.summary['total']}, Passed: {report.summary['passed']}")
```

## Runner API

### 初始化参数

```python
runner = Runner(
    log=logger,              # 日志对象
    failfast=False,          # 首次失败停止
    log_debug=False,         # 调试日志
    reveal_secrets=False,    # 显示敏感信息
    log_response_headers=False,  # 记录响应头
    persist_env_file=".env"  # 变量持久化文件
)
```

### 执行用例

```python
result = runner.run_case(
    case,           # Case 对象
    global_vars={}, # 全局变量
    params={},      # 参数化数据
    funcs={},       # 自定义函数
    envmap={},      # 环境变量
    source=""       # 源文件路径
)
```

### 结果对象

```python
# CaseInstanceResult
result.name          # 用例名称
result.status        # 状态: passed/failed/skipped
result.duration_ms   # 耗时（毫秒）
result.steps         # 步骤结果列表

# StepResult
step = result.steps[0]
step.name            # 步骤名称
step.status          # 状态
step.duration_ms     # 耗时
step.request         # 请求详情
step.response        # 响应详情
step.asserts         # 断言结果
step.extracts        # 提取变量
step.curl            # cURL 命令
```

## 模块结构

```python
from drun.models.case import Case
from drun.models.config import Config
from drun.models.step import Step
from drun.models.request import StepRequest
from drun.models.validators import Validator
from drun.models.report import RunReport, CaseResult, StepResult

from drun.loader.yaml_loader import load_yaml_file, expand_parameters
from drun.loader.collector import discover, match_tags
from drun.loader.env import load_environment
from drun.loader.hooks import get_functions_for

from drun.runner.runner import Runner
from drun.runner.assertions import compare
from drun.runner.extractors import extract_from_body

from drun.templating.engine import TemplateEngine
from drun.templating.builtins import BUILTINS

from drun.reporter.html_reporter import write_html
from drun.reporter.json_reporter import write_json

from drun.engine.http import HTTPClient
```

## 自定义报告器

### 实现报告生成

```python
from drun.models.report import RunReport
from typing import Dict, Any
import json

def write_custom_report(report: RunReport, path: str):
    """自定义报告生成"""
    data = {
        "title": "Custom Report",
        "summary": report.summary,
        "cases": []
    }
    
    for case in report.cases:
        case_data = {
            "name": case.name,
            "status": case.status,
            "duration": case.duration_ms,
            "steps": []
        }
        
        for step in case.steps:
            step_data = {
                "name": step.name,
                "status": step.status,
                "assertions": [
                    {
                        "check": a.check,
                        "passed": a.passed
                    }
                    for a in step.asserts
                ]
            }
            case_data["steps"].append(step_data)
        
        data["cases"].append(case_data)
    
    with open(path, "w") as f:
        json.dump(data, f, indent=2, ensure_ascii=False)
```

## 扩展断言函数

### 添加自定义断言

```python
from drun.runner.assertions import OPS

# 添加自定义断言
def json_schema_validate(actual, schema):
    """JSON Schema 验证"""
    import jsonschema
    try:
        jsonschema.validate(actual, schema)
        return True
    except jsonschema.ValidationError:
        return False

# 注册断言
OPS["json_schema"] = json_schema_validate
```

使用：

```yaml
validate:
  - json_schema: [$.data, {type: object, required: [id, name]}]
```

## 扩展内置函数

### 添加自定义函数

```python
from drun.templating.builtins import BUILTINS

def custom_hash(value: str) -> str:
    """自定义哈希函数"""
    import hashlib
    return hashlib.md5(value.encode()).hexdigest()

def custom_encrypt(value: str, key: str) -> str:
    """自定义加密函数"""
    # 实现加密逻辑
    return encrypted_value

# 注册函数
BUILTINS["custom_hash"] = custom_hash
BUILTINS["custom_encrypt"] = custom_encrypt
```

使用：

```yaml
body:
  hash: ${custom_hash(password)}
  encrypted: ${custom_encrypt(data, secret)}
```

## 集成示例

### Flask API 集成

```python
from flask import Flask, request, jsonify
from drun.loader.yaml_loader import load_yaml_file
from drun.loader.env import load_environment
from drun.runner.runner import Runner
from drun.utils.logging import setup_logging, get_logger
from pathlib import Path

app = Flask(__name__)
setup_logging("INFO")

@app.route("/api/run", methods=["POST"])
def run_test():
    data = request.json
    case_path = data.get("case_path")
    env_name = data.get("env", "dev")
    
    # 加载环境
    env_store = load_environment(env_name, f".env.{env_name}")
    
    # 加载用例
    cases, meta = load_yaml_file(Path(case_path))
    
    # 执行
    log = get_logger("api")
    runner = Runner(log=log)
    
    results = []
    for case in cases:
        result = runner.run_case(
            case,
            global_vars={},
            params={},
            funcs={},
            envmap=env_store,
            source=case_path
        )
        results.append({
            "name": result.name,
            "status": result.status,
            "duration_ms": result.duration_ms
        })
    
    return jsonify({"results": results})

if __name__ == "__main__":
    app.run(debug=True)
```

### 定时任务集成

```python
import schedule
import time
from drun.loader.yaml_loader import load_yaml_file
from drun.loader.env import load_environment
from drun.runner.runner import Runner
from drun.reporter.html_reporter import write_html
from drun.utils.logging import setup_logging, get_logger
from pathlib import Path

def run_smoke_test():
    setup_logging("INFO")
    log = get_logger("scheduler")
    
    env_store = load_environment("prod", ".env.prod")
    cases, _ = load_yaml_file(Path("testsuites/testsuite_smoke.yaml"))
    
    runner = Runner(log=log, persist_env_file=".env.prod")
    
    results = []
    for case in cases:
        result = runner.run_case(
            case, {}, {}, {}, env_store, ""
        )
        results.append(result)
    
    report = runner.build_report(results)
    
    timestamp = time.strftime("%Y%m%d-%H%M%S")
    write_html(report, f"reports/smoke-{timestamp}.html")
    
    log.info(f"Smoke test completed: {report.summary}")

# 每小时执行
schedule.every().hour.do(run_smoke_test)

while True:
    schedule.run_pending()
    time.sleep(60)
```

## 数据模型

### Case 模型

```python
from pydantic import BaseModel
from typing import List, Dict, Any, Optional

class Config(BaseModel):
    name: str
    base_url: Optional[str] = None
    tags: List[str] = []
    variables: Dict[str, Any] = {}
    headers: Dict[str, str] = {}
    timeout: float = 30.0

class Case(BaseModel):
    config: Config
    steps: List[Step]
    parameters: List[Dict] = []
```

### Step 模型

```python
class Step(BaseModel):
    name: str
    variables: Dict[str, Any] = {}
    request: Optional[StepRequest] = None
    invoke: Optional[str] = None
    extract: Dict[str, str] = {}
    validators: List[Validator] = []
    setup_hooks: List[str] = []
    teardown_hooks: List[str] = []
    skip: Optional[str] = None
    retry: int = 0
    retry_backoff: float = 0.5
```

## 注意事项

1. **线程安全**：Runner 不是线程安全的，并发场景需要创建多个实例
2. **资源清理**：长时间运行注意关闭 HTTP 连接
3. **日志配置**：建议统一使用 `setup_logging` 配置
4. **版本兼容**：关注版本更新，API 可能有变化
