# Drun 测试执行流程

## 一、整体执行流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            测试执行整体流程                                   │
└─────────────────────────────────────────────────────────────────────────────┘

用户输入: drun r test_login --env dev -k "smoke"
                │
                ▼
┌───────────────────────────────────────┐
│  1. CLI 解析命令行参数                 │
│     - path: test_login                │
│     - env: dev                        │
│     - k: smoke                        │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  2. 加载环境变量                       │
│     load_environment("dev", ".env.dev")│
│     → {BASE_URL, TOKEN, ...}          │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  3. 发现测试文件                       │
│     discover(["test_login"])          │
│     → [testcases/test_login.yaml]     │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  4. 加载并解析用例                     │
│     load_yaml_file(path)              │
│     → List[Case]                      │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  5. 标签过滤                          │
│     match_tags(case.tags, "smoke")    │
│     → 匹配的用例列表                   │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  6. 加载钩子函数                       │
│     get_functions_for(path)           │
│     → {setup_hook_xxx: func, ...}     │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  7. 展开参数化数据                     │
│     expand_parameters(case.parameters)│
│     → [{row1}, {row2}, ...]           │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  8. 执行测试用例                       │
│     runner.run_case(case, ...)        │
│     → CaseResult                      │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  9. 生成测试报告                       │
│     write_html(report, path)          │
│     write_json(report, path)          │
└───────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────┐
│  10. 发送通知 (可选)                   │
│      feishu/dingtalk/email            │
└───────────────────────────────────────┘
```

## 二、核心函数调用链

### 2.1 主入口调用链

```python
# 文件: cli.py

def _run_impl(path, env, k, ...):
    """
    测试执行核心实现
    
    调用链:
    _run_impl()
        │
        ├── load_environment(env, env_file)     # loader/env.py
        │       └── 读取 .env.{env} 文件
        │
        ├── discover([path])                     # loader/collector.py
        │       └── 递归查找 .yaml/.yml 文件
        │
        ├── load_yaml_file(file)                 # loader/yaml_loader.py
        │       ├── yaml.safe_load()
        │       ├── _normalize_case_dict()
        │       └── Case.model_validate()
        │
        ├── match_tags(tags, k)                  # loader/collector.py
        │       └── 布尔表达式解析
        │
        ├── get_functions_for(path)              # loader/hooks.py
        │       ├── find_hooks()
        │       └── _import_module_from_path()
        │
        ├── expand_parameters(params)            # loader/yaml_loader.py
        │       └── _load_csv_parameters()
        │
        ├── Runner.run_case(case, ...)           # runner/runner.py
        │       └── (见下一节详解)
        │
        ├── write_html(report, path)             # reporter/html_reporter.py
        │
        └── notify(result)                       # notifier/
    """
```

### 2.2 Runner.run_case() 调用链

```python
# 文件: runner/runner.py

def run_case(self, case, global_vars, params, funcs, envmap, source):
    """
    执行单个测试用例
    
    调用链:
    run_case()
        │
        ├── VarContext(rendered_base)            # templating/context.py
        │       └── 初始化变量上下文
        │
        ├── _build_client(case)
        │       └── HTTPClient(base_url, ...)    # engine/http.py
        │
        ├── _run_setup_hooks(case.setup_hooks)
        │       └── templater.eval_expr()        # templating/engine.py
        │
        ├── for step in case.steps:              # 遍历每个步骤
        │       │
        │       ├── 检查 skip 条件
        │       │
        │       ├── ctx.push(step.variables)     # 合并步骤变量
        │       │
        │       ├── if step.invoke:              # invoke 类型步骤
        │       │       └── _run_invoke_step()
        │       │               ├── resolve_invoke_path()
        │       │               ├── load_yaml_file()
        │       │               └── run_case()   # 递归调用
        │       │
        │       ├── _render(req_dict, vars)      # 渲染请求
        │       │       └── TemplateEngine.render_value()
        │       │
        │       ├── _run_setup_hooks(step.setup_hooks)
        │       │
        │       ├── client.request(req)          # 发送 HTTP 请求
        │       │       └── httpx.request()
        │       │
        │       ├── for var, expr in extract:    # 提取数据
        │       │       └── _eval_extract(expr, resp)
        │       │               └── extract_from_body()  # extractors.py
        │       │
        │       ├── for v in validators:         # 执行断言
        │       │       ├── _resolve_check()
        │       │       └── compare()            # assertions.py
        │       │
        │       ├── _run_teardown_hooks(step.teardown_hooks)
        │       │
        │       └── StepResult(...)              # 生成步骤结果
        │
        ├── _run_teardown_hooks(case.teardown_hooks)
        │
        └── return CaseInstanceResult(...)
    """
```

## 三、单步骤执行详细流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          单步骤执行流程 (10个阶段)                            │
└─────────────────────────────────────────────────────────────────────────────┘

步骤定义 (YAML):
┌─────────────────────────────────────────┐
│ - name: 用户登录                         │
│   variables:                            │
│     username: admin                     │
│   request:                              │
│     method: POST                        │
│     path: /api/login                    │
│     body:                               │
│       username: $username               │
│       password: ${ENV(PASSWORD)}        │
│   extract:                              │
│     token: $.data.token                 │
│     userId: $.data.user.id              │
│   validate:                             │
│     - eq: [status_code, 200]            │
│     - ne: [$.data.token, null]          │
└─────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段1: 检查跳过条件                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   if step.skip:                                                             │
│       log.info(f"跳过步骤: {step.name}")                                     │
│       return StepResult(status="skipped")                                   │
│                                                                             │
│   skip 支持的值:                                                             │
│   - true/false                                                              │
│   - "原因说明"                                                               │
│   - ${condition}  (动态计算)                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段2: 合并变量上下文                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   变量优先级 (从低到高):                                                      │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │ 1. Case级变量 (config.variables)         最低优先级              │      │
│   │ 2. 参数化数据 (CSV行数据)                                        │      │
│   │ 3. Step级变量 (step.variables)                                  │      │
│   │ 4. 前一步骤提取的变量 (extract)                                   │      │
│   │ 5. CLI参数 (--vars key=value)                                   │      │
│   │ 6. 环境变量 (ENV)                        最高优先级              │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│   代码:                                                                      │
│   ctx.push(step.variables)                                                  │
│   variables = ctx.get_merged(global_vars)                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段3: 判断步骤类型                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   if step.invoke:                                                           │
│       # invoke 类型: 调用其他测试用例                                         │
│       return _run_invoke_step(step, ...)                                    │
│   else:                                                                     │
│       # request 类型: 执行 HTTP 请求                                         │
│       继续后续阶段                                                           │
│                                                                             │
│   invoke 示例:                                                               │
│   - name: 执行登录流程                                                       │
│     invoke: test_login        # 调用 testcases/test_login.yaml             │
│     variables:                                                              │
│       username: admin         # 传递变量给被调用用例                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段4: 渲染请求参数                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   原始请求:                              渲染后:                             │
│   ┌──────────────────────────┐         ┌──────────────────────────┐        │
│   │ method: POST             │         │ method: POST             │        │
│   │ path: /api/login         │   ───▶  │ path: /api/login         │        │
│   │ body:                    │         │ body:                    │        │
│   │   username: $username    │         │   username: admin        │        │
│   │   password: ${ENV(PASS)} │         │   password: secret123    │        │
│   └──────────────────────────┘         └──────────────────────────┘        │
│                                                                             │
│   代码:                                                                      │
│   req_rendered = self._render(req_dict, variables, funcs, envmap)           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段5: 执行前置钩子 (setup_hooks)                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   YAML:                                                                     │
│   setup_hooks:                                                              │
│     - ${setup_hook_sign_request($request)}                                  │
│                                                                             │
│   执行过程:                                                                  │
│   1. 解析表达式 ${setup_hook_sign_request($request)}                         │
│   2. 从 drun_hooks.py 找到函数 setup_hook_sign_request                       │
│   3. 调用函数，传入 hook_ctx (包含 request, variables, env 等)               │
│   4. 函数返回的字典合并到变量上下文                                           │
│                                                                             │
│   hook_ctx 结构:                                                             │
│   {                                                                         │
│       "request": {...},           # 当前请求                                │
│       "variables": {...},         # 变量上下文                              │
│       "env": {...},               # 环境变量                                │
│       "step_name": "用户登录",     # 步骤名称                                │
│       "case_name": "登录测试",     # 用例名称                                │
│   }                                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段6: 发送 HTTP 请求                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   代码:                                                                      │
│   resp_obj = client.request(req_rendered)                                   │
│                                                                             │
│   支持重试:                                                                  │
│   retry: 3           # 最多重试3次                                          │
│   retry_backoff: 0.5 # 重试间隔，指数退避                                    │
│                                                                             │
│   返回结构:                                                                  │
│   {                                                                         │
│       "status_code": 200,                                                   │
│       "headers": {"Content-Type": "application/json", ...},                 │
│       "body": {"code": 0, "data": {...}},                                   │
│       "elapsed_ms": 123.4,                                                  │
│       "url": "https://api.example.com/api/login",                           │
│       "method": "POST"                                                      │
│   }                                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段7: 提取响应数据 (extract)                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   YAML:                                      提取结果:                       │
│   extract:                                   ┌────────────────────┐         │
│     token: $.data.token          ───▶        │ token: "eyJ..."    │         │
│     userId: $.data.user.id                   │ userId: 12345      │         │
│                                              └────────────────────┘         │
│                                                                             │
│   代码:                                                                      │
│   for var, expr in step.extract.items():                                    │
│       value = self._eval_extract(expr, resp_obj)                            │
│       ctx.set_base(var, value)                                              │
│                                                                             │
│   JMESPath 语法示例:                                                         │
│   ┌────────────────────────────┬─────────────────────────────┐              │
│   │ 表达式                     │ 含义                         │              │
│   ├────────────────────────────┼─────────────────────────────┤              │
│   │ $.data                     │ body.data                   │              │
│   │ $.data.items[0]            │ 数组第一个元素               │              │
│   │ $.data.items[*].id         │ 所有元素的 id                │              │
│   │ $.data.items | length(@)   │ 数组长度                     │              │
│   │ $headers.Content-Type      │ 响应头                       │              │
│   │ $status_code               │ 状态码                       │              │
│   │ $elapsed_ms                │ 响应时间(毫秒)               │              │
│   └────────────────────────────┴─────────────────────────────┘              │
│                                                                             │
│   提取后自动持久化到 .env 文件:                                               │
│   token    → TOKEN=eyJ...                                                   │
│   userId   → USER_ID=12345                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段8: 执行断言校验 (validate)                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   YAML:                                                                     │
│   validate:                                                                 │
│     - eq: [status_code, 200]                                                │
│     - ne: [$.data.token, null]                                              │
│     - contains: [$.message, success]                                        │
│                                                                             │
│   执行过程:                                                                  │
│   for v in step.validators:                                                 │
│       # 1. 获取实际值                                                        │
│       actual = self._resolve_check(v.check, resp_obj)                       │
│                                                                             │
│       # 2. 渲染期望值 (支持变量)                                              │
│       expect = self._render(v.expect, variables)                            │
│                                                                             │
│       # 3. 执行比较                                                          │
│       passed, error = compare(v.comparator, actual, expect)                 │
│                                                                             │
│       # 4. 记录结果                                                          │
│       assertions.append(AssertionResult(                                    │
│           check=v.check,                                                    │
│           comparator=v.comparator,                                          │
│           expect=expect,                                                    │
│           actual=actual,                                                    │
│           passed=passed                                                     │
│       ))                                                                    │
│                                                                             │
│   断言失败时:                                                                 │
│   - 记录错误日志                                                             │
│   - 如果 failfast=True，立即停止                                             │
│   - 否则继续执行后续步骤                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段9: 执行后置钩子 (teardown_hooks)                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   YAML:                                                                     │
│   teardown_hooks:                                                           │
│     - ${teardown_hook_cleanup($response)}                                   │
│                                                                             │
│   hook_ctx 包含响应信息:                                                      │
│   {                                                                         │
│       "response": {...},          # 响应数据                                │
│       "variables": {...},         # 变量上下文                              │
│       "env": {...},               # 环境变量                                │
│   }                                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 阶段10: 生成步骤结果                                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   return StepResult(                                                        │
│       name="用户登录",                                                       │
│       status="passed" | "failed" | "skipped",                               │
│       request={                                                             │
│           "method": "POST",                                                 │
│           "path": "/api/login",                                             │
│           "headers": {...},                                                 │
│           "body": {...}                                                     │
│       },                                                                    │
│       response={                                                            │
│           "status_code": 200,                                               │
│           "body": {...}                                                     │
│       },                                                                    │
│       curl="curl -X POST ...",     # 可复制的 cURL 命令                      │
│       asserts=[...],               # 断言结果列表                            │
│       extracts={"token": "eyJ..."},# 提取的变量                              │
│       duration_ms=123.4            # 步骤耗时                                │
│   )                                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 四、关键判断逻辑说明

### 4.1 如何判断执行哪个文件？

```python
# loader/collector.py

def discover(paths: List[str]) -> List[Path]:
    """
    判断规则:
    
    1. 输入是目录 → 递归搜索该目录
    2. 输入是文件 → 直接使用
    3. 输入不存在 → 智能搜索
    
    智能搜索顺序:
    - testcases/{input}.yaml
    - testcases/{input}.yml
    - testsuites/{input}.yaml
    - testsuites/{input}.yml
    """
```

### 4.2 如何判断执行哪些步骤？

```python
# runner/runner.py

for step in case.steps:
    # 1. 检查 skip 条件
    if step.skip:
        continue
    
    # 2. 根据步骤类型选择执行方式
    if step.invoke:
        # invoke 类型: 调用其他用例
        results = self._run_invoke_step(step, ...)
    else:
        # request 类型: 执行 HTTP 请求
        resp = client.request(req)
```

### 4.3 如何判断调用哪些钩子函数？

```python
# loader/hooks.py

def get_functions_for(start: Path) -> Dict[str, Any]:
    """
    1. 从测试文件位置向上搜索 drun_hooks.py
    2. 动态导入该模块
    3. 收集所有可调用对象 (函数)
    4. 返回 {函数名: 函数对象} 字典
    """

# runner/runner.py

def _run_setup_hooks(self, names, ...):
    """
    1. 解析 ${func_name($arg)} 表达式
    2. 从 funcs 字典中查找函数
    3. 调用函数并传入 hook_ctx
    """
```
