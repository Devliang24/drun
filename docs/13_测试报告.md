# 测试报告

Drun 支持多种格式的测试报告，满足不同场景需求。

## HTML 报告

### 生成方式

```bash
drun r testcases --env dev --html reports/report.html
```

### 报告特点

- **单文件**：无外部依赖，可直接分享
- **响应式**：支持桌面和移动端查看
- **详细信息**：
  - 测试概览（通过/失败/跳过）
  - 每个步骤的请求和响应
  - 断言结果高亮
  - cURL 命令（可复制）
  - 执行时间统计
- **敏感信息脱敏**：配合 `--mask-secrets`
- **质量评分**：显示用例和步骤评分

### 报告内容

```
┌─────────────────────────────────────────────────────────────┐
│  测试报告 - 2025-01-01 12:00:00                             │
│  环境: dev | 耗时: 5.2s | 评分: B (78)                      │
├─────────────────────────────────────────────────────────────┤
│  概览                                                       │
│  ┌─────────┬─────────┬─────────┬─────────┐                 │
│  │  Total  │ Passed  │ Failed  │ Skipped │                 │
│  │    10   │    8    │    1    │    1    │                 │
│  └─────────┴─────────┴─────────┴─────────┘                 │
├─────────────────────────────────────────────────────────────┤
│  用例列表                                                   │
│  ✓ 用户登录测试 (1.2s)                                      │
│  ✓ 用户信息获取 (0.8s)                                      │
│  ✗ 订单创建测试 (2.1s) ← 点击展开详情                        │
│  ○ 支付测试 (跳过)                                          │
└─────────────────────────────────────────────────────────────┘
```

### 步骤详情

展开每个步骤可查看：

- **请求信息**：Method、URL、Headers、Body
- **响应信息**：Status、Headers、Body
- **断言结果**：每条断言的通过/失败状态
- **cURL 命令**：可复制执行
- **提取变量**：显示提取的变量值
- **执行时间**：精确到毫秒

## JSON 报告

### 生成方式

```bash
drun r testcases --env dev --report reports/results.json
```

### 报告结构

```json
{
  "summary": {
    "total": 10,
    "passed": 8,
    "failed": 1,
    "skipped": 1,
    "duration_ms": 5234.5,
    "steps_total": 25,
    "steps_passed": 22,
    "steps_failed": 2,
    "steps_skipped": 1
  },
  "environment": "dev",
  "start_time": "2025-01-01T12:00:00",
  "end_time": "2025-01-01T12:00:05",
  "cases": [
    {
      "name": "用户登录测试",
      "status": "passed",
      "duration_ms": 1234.5,
      "file": "testcases/test_login.yaml",
      "tags": ["smoke", "auth"],
      "steps": [
        {
          "name": "登录请求",
          "status": "passed",
          "duration_ms": 456.7,
          "request": {
            "method": "POST",
            "url": "https://api.example.com/login",
            "headers": {...},
            "body": {...}
          },
          "response": {
            "status_code": 200,
            "headers": {...},
            "body": {...}
          },
          "asserts": [
            {
              "check": "status_code",
              "comparator": "eq",
              "expect": 200,
              "actual": 200,
              "passed": true
            }
          ],
          "extracts": {
            "token": "eyJhbGciOiJIUzI1NiIs..."
          }
        }
      ]
    }
  ]
}
```

### 用途

- CI/CD 流水线结果解析
- 自定义报告生成
- 测试结果存档
- 数据分析

## Allure 报告

### 生成方式

```bash
# 生成 Allure 结果
drun r testcases --env dev --allure-results allure-results

# 查看报告（需安装 Allure）
allure serve allure-results
```

### Allure 安装

```bash
# macOS
brew install allure

# Linux
sudo apt-get install allure

# Windows
scoop install allure
```

### 报告特点

- 美观的可视化界面
- 丰富的统计图表
- 历史趋势分析
- 与 CI/CD 集成

## Web 报告服务器

### 启动服务器

```bash
# 默认启动
drun s

# 指定端口
drun s --port 8080

# 不自动打开浏览器
drun s --no-open

# 开发模式
drun s --reload
```

### 功能

- **报告列表**：分页显示所有 HTML 报告
- **报告详情**：在线查看报告内容
- **自动扫描**：监控 `reports/` 目录变化
- **SQLite 索引**：快速检索报告
- **RESTful API**：`/api/reports`

### API 端点

```bash
# 获取报告列表
GET /api/reports?page=1&size=18

# 获取报告详情
GET /api/reports/{id}

# 统计信息
GET /api/reports/stats
```

## 报告配置

### 输出目录

```bash
# 自定义 HTML 报告路径
drun r testcases --env dev --html custom/path/report.html

# 自定义 JSON 报告路径
drun r testcases --env dev --report custom/path/results.json
```

### 文件命名

默认命名包含时间戳和系统名：

```
reports/
├── myproject-20250101-120000.html
├── myproject-20250101-130000.html
└── myproject-20250101-140000.html
```

### 敏感信息脱敏

```bash
# 启用脱敏
drun r testcases --env dev --html report.html --mask-secrets
```

脱敏字段：

- Authorization 头
- Token 值
- 密码字段
- API Key

## CI/CD 集成

### GitHub Actions

```yaml
- name: Run Tests
  run: |
    drun r testsuites/testsuite_smoke.yaml --env ci \
      --html reports/report.html \
      --report reports/results.json \
      --mask-secrets

- name: Upload Reports
  uses: actions/upload-artifact@v3
  if: always()
  with:
    name: test-reports
    path: reports/
```

### Jenkins

```groovy
stage('Test') {
    steps {
        sh '''
            drun r testcases --env ci \
              --html reports/report.html \
              --report reports/results.json
        '''
    }
    post {
        always {
            archiveArtifacts artifacts: 'reports/*', fingerprint: true
            publishHTML target: [
                reportDir: 'reports',
                reportFiles: 'report.html',
                reportName: 'Test Report'
            ]
        }
    }
}
```

### GitLab CI

```yaml
test:
  script:
    - drun r testcases --env ci --html reports/report.html
  artifacts:
    when: always
    paths:
      - reports/
    reports:
      junit: reports/results.json
```

## 最佳实践

### 1. 报告命名规范

```bash
# 按日期组织
reports/2025-01/report-20250101.html

# 按环境组织
reports/dev/smoke-20250101.html
reports/prod/regression-20250101.html
```

### 2. 报告清理

定期清理旧报告：

```bash
# 保留最近 30 天
find reports/ -name "*.html" -mtime +30 -delete
```

### 3. 报告归档

```bash
# 压缩归档
tar -czf reports-2025-01.tar.gz reports/2025-01/
```
