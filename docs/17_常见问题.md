# 常见问题

关于 Drun 的常见问题解答。

## 基础问题

### Drun 名字的由来？

**Drun** 是 **D**eveloper **Run** 的缩写，寓意：
- 开发者友好的测试框架
- 简单的运行方式（drun run / drun r）
- 像喝水（drink）一样简单自然

### 必须学习 Python 吗？

**不需要**。Drun 的日常使用完全基于 YAML 编写测试用例：

- 测试用例：YAML 格式
- 内置函数：`${uuid()}`、`${now()}` 等开箱即用
- 命令行：简单的 CLI 命令

只有在以下高级场景才需要 Python：
- 编写自定义 Hook 函数
- 二次开发和平台集成

### 支持哪些操作系统？

- macOS (Intel/M1/M2)
- Linux (x86_64/arm64)
- Windows (x86_64)

### Python 版本要求？

Python 3.10 或更高版本。

## 安装问题

### pip install 失败

**问题**：安装时报错 `No matching distribution found`

**解决**：
```bash
# 1. 确认 Python 版本
python3 --version  # 需要 3.10+

# 2. 升级 pip
pip install --upgrade pip

# 3. 使用国内镜像
pip install drun -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 虚拟环境问题

**推荐**：始终使用虚拟环境

```bash
# 使用 uv（推荐）
uv venv && source .venv/bin/activate
uv pip install drun

# 或使用标准方式
python3 -m venv .venv
source .venv/bin/activate
pip install drun
```

## 运行问题

### 提示 "未指定环境"

**问题**：
```
[ERROR] 未指定环境，请使用 --env 参数
```

**解决**：
```bash
# 必须指定 --env 参数
drun r testcases --env dev
```

### 环境文件不存在

**问题**：
```
[ERROR] 环境文件不存在: .env.dev
```

**解决**：创建对应的环境文件
```bash
# 创建 .env.dev
cat > .env.dev << EOF
BASE_URL=https://api.example.com
API_KEY=your-key
EOF
```

### BASE_URL 缺失

**问题**：
```
[ERROR] base_url is required for cases using relative URLs
```

**解决**：在环境文件或用例中配置 BASE_URL
```bash
# .env.dev
BASE_URL=https://api.example.com
```

或在用例中：
```yaml
config:
  base_url: https://api.example.com
```

### 找不到测试文件

**问题**：
```
No YAML test files found at: test_login
```

**解决**：
```bash
# 1. 确认文件存在
ls testcases/

# 2. 使用正确的路径
drun r testcases/test_login.yaml --env dev

# 3. 或省略后缀（自动搜索）
drun r test_login --env dev
```

## 用例编写问题

### 变量未替换

**问题**：`$token` 没有被替换为实际值

**排查**：
1. 检查变量是否已定义
2. 检查变量名大小写（区分大小写）
3. 检查变量作用域

```yaml
# 正确
config:
  variables:
    token: abc123

steps:
  - name: 使用变量
    request:
      headers:
        Authorization: Bearer $token  # ✓
```

### 断言失败

**问题**：断言失败但不知道原因

**调试**：
```bash
# 启用调试日志
drun r test_api --env dev --log-level DEBUG --reveal-secrets
```

查看实际值和期望值：
```
[ASSERT] FAILED: eq [$.code, 0]
  actual: 1
  expect: 0
```

### 提取失败

**问题**：`extract` 提取不到数据

**排查**：
1. 确认响应结构
2. 检查 JMESPath 语法

```bash
# 调试查看响应
drun r test_api --env dev --log-level DEBUG
```

JMESPath 语法示例：
```yaml
extract:
  # 简单路径
  id: $.data.id
  
  # 数组
  firstId: $.data.items[0].id
  
  # 响应头
  contentType: $headers.Content-Type
```

### Hook 函数不执行

**问题**：`setup_hooks` 中的函数没有执行

**排查**：
1. 确认 `drun_hooks.py` 文件位置（项目根目录）
2. 确认函数名正确
3. 确认语法正确

```python
# drun_hooks.py - 正确写法
def my_hook(hook_ctx):
    return {"key": "value"}
```

```yaml
# 用例 - 正确调用
setup_hooks:
  - ${my_hook($request)}
```

## 报告问题

### HTML 报告无法打开

**问题**：浏览器显示空白

**解决**：
1. 确认报告文件完整生成
2. 尝试其他浏览器
3. 检查文件编码（应为 UTF-8）

### 报告中敏感信息泄露

**解决**：使用 `--mask-secrets`
```bash
drun r testcases --env dev --html report.html --mask-secrets
```

## 通知问题

### 飞书通知失败

**排查**：
1. 检查 Webhook 地址
2. 确认机器人未被禁用
3. 检查网络连接

```bash
# 测试 Webhook
curl -X POST $FEISHU_WEBHOOK \
  -H "Content-Type: application/json" \
  -d '{"msg_type":"text","content":{"text":"test"}}'
```

### 钉钉加签失败

**解决**：确认 `DINGTALK_SECRET` 正确
```bash
# .env.dev
DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=xxx
DINGTALK_SECRET=SECxxxxxxxx
```

### 邮件发送失败

**排查**：
1. 检查 SMTP 配置
2. 使用应用专用密码（Gmail/QQ 等）
3. 检查发件人权限

```bash
# .env.dev
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SSL=true
SMTP_USER=your@gmail.com
SMTP_PASS=app-specific-password  # 应用专用密码
```

## 性能问题

### 测试执行慢

**优化建议**：
1. 使用 `--failfast` 快速失败
2. 减少不必要的断言
3. 优化 Hook 函数
4. 使用标签过滤只运行必要的用例

```bash
# 快速冒烟测试
drun r testcases --env dev -k "smoke" --failfast
```

### 内存占用高

**建议**：
1. 分批运行大量用例
2. 避免在用例中存储大量数据
3. 及时清理报告文件

## 其他问题

### 如何调试？

```bash
# 1. 启用调试日志
drun r test_api --env dev --log-level DEBUG

# 2. 显示敏感信息
drun r test_api --env dev --reveal-secrets

# 3. 查看响应头
drun r test_api --env dev --response-headers

# 4. 组合使用
drun r test_api --env dev --log-level DEBUG --reveal-secrets --response-headers
```

### 如何查看版本？

```bash
drun --version
```

### 如何获取帮助？

```bash
# 查看所有命令
drun --help

# 查看特定命令帮助
drun run --help
drun convert --help
```

### 如何反馈问题？

1. GitHub Issues: https://github.com/Devliang24/drun/issues
2. 提供：Drun 版本、Python 版本、错误日志、复现步骤
