# 快速上手

Drun 的首要目标是「简单易用」，本文帮助你在 10 分钟内快速上手。

## 安装部署

```bash
# 推荐使用 uv（更快）
curl -LsSf https://astral.sh/uv/install.sh | sh
uv venv && source .venv/bin/activate
uv pip install drun

# 或使用 pip
pip install drun
```

安装成功后，执行 `drun --version` 验证：

```bash
$ drun --version
drun version 7.0.17
```

## 脚手架创建项目

```bash
$ drun init myproject
$ cd myproject
```

生成的项目结构：

```
myproject/
├── testcases/                  # 测试用例目录
│   ├── test_demo.yaml          # HTTP 功能演示
│   ├── test_api_health.yaml    # 健康检查示例
│   └── test_import_users.yaml  # CSV 参数化示例
├── testsuites/                 # 测试套件目录
│   └── testsuite_smoke.yaml    # 冒烟测试套件
├── data/                       # 测试数据目录
│   └── users.csv               # CSV 参数数据
├── converts/                   # 格式转换源文件
│   └── sample.curl             # cURL 命令示例
├── reports/                    # 报告输出目录
├── logs/                       # 日志输出目录
├── snippets/                   # 代码片段目录
├── .env                        # 环境变量
├── drun_hooks.py               # 自定义钩子函数
└── .gitignore
```

## 配置环境变量

创建 `.env.dev` 文件：

```bash
BASE_URL=https://postman-echo.com
API_KEY=your-api-key-here
```

## 初览测试用例

查看 `testcases/test_demo.yaml`：

```yaml
config:
  name: HTTP 功能演示
  base_url: ${ENV(BASE_URL)}
  tags: [smoke, demo]

steps:
  - name: GET 请求测试
    request:
      method: GET
      path: /get
      params:
        foo: bar
        timestamp: ${now()}
    extract:
      args_foo: $.args.foo
    validate:
      - eq: [status_code, 200]
      - eq: [$.args.foo, bar]

  - name: POST 请求测试
    request:
      method: POST
      path: /post
      headers:
        Content-Type: application/json
      body:
        username: testuser_${uuid()}
        email: ${fake_email()}
    validate:
      - eq: [status_code, 200]
      - contains: [$.data.username, testuser_]
```

### 用例结构说明

- **config**: 用例配置
  - `name`: 用例名称
  - `base_url`: 基础 URL，支持环境变量
  - `tags`: 标签，用于过滤

- **steps**: 测试步骤列表
  - `name`: 步骤名称
  - `request`: HTTP 请求
  - `extract`: 数据提取
  - `validate`: 结果断言

### 模板语法

- `$variable` 或 `${variable}`: 引用变量
- `${func()}`: 调用函数
- `${ENV(NAME)}`: 读取环境变量

## 运行接口测试

```bash
# 运行单个测试
$ drun r test_demo --env dev

# 运行并生成 HTML 报告
$ drun r test_demo --env dev --html reports/demo.html

# 按标签过滤
$ drun r testcases --env dev -k "smoke"

# 运行测试套件
$ drun r testsuite_smoke --env dev
```

### 运行输出

```
2025-01-01 10:00:00.123 | INFO | [ENV] Using environment: dev -> .env.dev
2025-01-01 10:00:00.124 | INFO | [ENV] BASE_URL = 'https://postman-echo.com'
2025-01-01 10:00:00.125 | INFO | [RUN] Discovered files: 1 | Matched cases: 1 | Failfast=False
2025-01-01 10:00:00.126 | INFO | [CASE] Start: HTTP 功能演示 | params={}
2025-01-01 10:00:00.500 | INFO | [STEP] GET 请求测试 | status=passed | 234.5ms
2025-01-01 10:00:00.800 | INFO | [STEP] POST 请求测试 | status=passed | 198.3ms
2025-01-01 10:00:00.801 | INFO | [CASE] Result: HTTP 功能演示 | status=passed | duration=432.8ms
2025-01-01 10:00:00.802 | INFO | [CASE] Total: 1 Passed: 1 Failed: 0 Skipped: 0
2025-01-01 10:00:00.803 | INFO | [CASE] HTML report written to reports/demo.html
```

## 查看测试报告

生成的 HTML 报告是单文件，无外部依赖，可直接分享：

- 测试概览：通过/失败/跳过统计
- 详细信息：每个步骤的请求/响应
- 断言结果：高亮显示通过/失败
- cURL 命令：可复制执行

## 编写你的第一个测试

### 1. 创建环境文件

```bash
# .env.dev
BASE_URL=https://api.example.com
TOKEN=your-token-here
```

### 2. 创建测试用例

```yaml
# testcases/test_users.yaml
config:
  name: 用户接口测试
  base_url: ${ENV(BASE_URL)}
  tags: [smoke, users]

steps:
  - name: 获取用户列表
    request:
      method: GET
      path: /api/users
      headers:
        Authorization: Bearer ${ENV(TOKEN)}
    extract:
      firstUserId: $.data[0].id
    validate:
      - eq: [status_code, 200]
      - gt: [$.data | length(@), 0]

  - name: 获取用户详情
    request:
      method: GET
      path: /api/users/$firstUserId
      headers:
        Authorization: Bearer ${ENV(TOKEN)}
    validate:
      - eq: [status_code, 200]
      - eq: [$.data.id, $firstUserId]
```

### 3. 运行测试

```bash
$ drun r test_users --env dev --html reports/users.html
```

## 总结

恭喜！你已经学会了：

1. **安装 Drun**: `pip install drun`
2. **创建项目**: `drun init myproject`
3. **配置环境**: `.env.dev` 文件
4. **编写用例**: YAML 格式
5. **运行测试**: `drun r <path> --env <env>`
6. **查看报告**: HTML 单文件报告

更多高级功能，请阅读后续章节。
