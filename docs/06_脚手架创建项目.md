# 脚手架创建项目

使用 `drun init` 命令快速创建标准化的测试项目。

## 基本用法

```bash
# 创建项目
drun init myproject

# 进入项目目录
cd myproject
```

## 命令参数

```bash
drun init <project_name> [OPTIONS]

Options:
  --ci      包含 GitHub Actions CI 工作流
  --force   强制覆盖已存在的目录
```

## 项目结构

```
myproject/
├── testcases/                  # 测试用例目录
│   ├── test_demo.yaml          # HTTP 功能演示
│   ├── test_api_health.yaml    # 健康检查示例
│   └── test_import_users.yaml  # CSV 参数化示例
├── testsuites/                 # 测试套件目录
│   └── testsuite_smoke.yaml    # 冒烟测试套件
├── data/                       # 测试数据目录
│   └── users.csv               # CSV 参数数据
├── converts/                   # 格式转换源文件
│   └── sample.curl             # cURL 命令示例
├── reports/                    # 报告输出目录
├── logs/                       # 日志输出目录
├── snippets/                   # 代码片段目录
├── .env                        # 环境变量模板
├── drun_hooks.py               # 自定义钩子函数
└── .gitignore                  # Git 忽略规则
```

## 目录说明

### testcases/

存放测试用例文件，命名规范：`test_*.yaml`

```yaml
# testcases/test_api_health.yaml
config:
  name: API 健康检查
  base_url: ${ENV(BASE_URL)}
  tags: [smoke, health]

steps:
  - name: 健康检查
    request:
      method: GET
      path: /health
    validate:
      - eq: [status_code, 200]
```

### testsuites/

存放测试套件文件，命名规范：`testsuite_*.yaml`

```yaml
# testsuites/testsuite_smoke.yaml
config:
  name: 冒烟测试套件
  tags: [smoke]

caseflow:
  - name: 健康检查
    invoke: test_api_health
  - name: 登录测试
    invoke: test_login
```

### data/

存放测试数据文件（CSV、JSON 等）。

```csv
# data/users.csv
username,email,role
alice,alice@example.com,admin
bob,bob@example.com,user
```

### converts/

存放待转换的源文件（cURL、HAR 等）。

```bash
# converts/sample.curl
curl -X POST https://api.example.com/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "123456"}'
```

### reports/

测试报告输出目录，包含 HTML/JSON/Allure 报告。

### logs/

日志文件输出目录。

### snippets/

自动生成的代码片段目录（Shell/Python）。

## 环境变量文件

### .env（模板）

```bash
# 基础配置
BASE_URL=https://api.example.com
TIMEOUT=30

# 认证信息
API_KEY=your-api-key
TOKEN=your-token
```

### 多环境配置

创建不同环境的配置文件：

```bash
# .env.dev - 开发环境
BASE_URL=https://dev-api.example.com
API_KEY=dev-key

# .env.uat - 测试环境
BASE_URL=https://uat-api.example.com
API_KEY=uat-key

# .env.prod - 生产环境
BASE_URL=https://api.example.com
API_KEY=prod-key
```

运行时指定环境：

```bash
drun r testcases --env dev   # 使用 .env.dev
drun r testcases --env uat   # 使用 .env.uat
drun r testcases --env prod  # 使用 .env.prod
```

## 钩子函数文件

### drun_hooks.py

```python
import hmac
import hashlib
import time

def get_timestamp():
    """获取当前时间戳"""
    return str(int(time.time()))

def sign_request(hook_ctx):
    """请求签名示例"""
    secret = hook_ctx['env'].get('API_SECRET', '')
    timestamp = str(int(time.time()))
    message = f"{timestamp}:{hook_ctx.get('body', '')}"
    signature = hmac.new(
        secret.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()
    return {
        'timestamp': timestamp,
        'signature': signature
    }

def setup_hook_log(hook_ctx):
    """前置钩子日志"""
    print(f"[SETUP] Step: {hook_ctx.get('step_name')}")

def teardown_hook_log(hook_ctx):
    """后置钩子日志"""
    print(f"[TEARDOWN] Step: {hook_ctx.get('step_name')}")
```

## CI 模式

使用 `--ci` 参数创建包含 GitHub Actions 工作流的项目：

```bash
drun init myproject --ci
```

额外生成：

```
myproject/
└── .github/
    └── workflows/
        └── api-tests.yml
```

### api-tests.yml

```yaml
name: API Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Drun
        run: pip install drun
      
      - name: Setup Environment
        run: |
          echo "BASE_URL=${{ secrets.BASE_URL }}" >> .env.ci
          echo "API_KEY=${{ secrets.API_KEY }}" >> .env.ci
      
      - name: Run Tests
        run: |
          drun r testsuites/testsuite_smoke.yaml --env ci \
            --html reports/report.html \
            --mask-secrets \
            --failfast
      
      - name: Upload Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-reports
          path: reports/
```

## 最佳实践

### 命名规范

- 测试用例：`test_<功能>.yaml`
- 测试套件：`testsuite_<场景>.yaml`
- 环境文件：`.env.<环境名>`

### 目录组织

按模块组织测试用例：

```
testcases/
├── auth/
│   ├── test_login.yaml
│   └── test_logout.yaml
├── users/
│   ├── test_create_user.yaml
│   └── test_get_user.yaml
└── orders/
    └── test_create_order.yaml
```

### Git 忽略

确保 `.gitignore` 包含：

```
.env
.env.*
!.env.example
reports/
logs/
snippets/
__pycache__/
*.pyc
.venv/
```
