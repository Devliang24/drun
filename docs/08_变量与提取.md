# 变量与提取

变量系统是 Drun 的核心功能之一，支持参数声明、引用、提取和自动持久化。

## 变量声明

### 全局变量（config.variables）

在 `config` 下声明的变量为全局变量，作用域为整个测试用例。

```yaml
config:
  name: 用户测试
  variables:
    baseUrl: https://api.example.com
    timeout: 30
    adminUser: admin
```

### 步骤变量（step.variables）

在单个步骤下声明的变量为局部变量，作用域仅限当前步骤。

```yaml
steps:
  - name: 创建用户
    variables:
      username: testuser_${uuid()}
      email: ${fake_email()}
    request:
      method: POST
      path: /api/users
      body:
        username: $username
        email: $email
```

### 参数化变量（parameters）

通过 CSV 数据驱动，每行数据作为一组变量。

```yaml
config:
  parameters:
    - csv:
        path: data/users.csv
```

### 提取变量（extract）

从响应中提取数据并存为变量。

```yaml
steps:
  - name: 登录
    request:
      method: POST
      path: /api/login
    extract:
      token: $.data.token
      userId: $.data.user.id
```

## 变量优先级

当同名变量存在多个来源时，按以下优先级（从低到高）：

```
1. config.variables      (最低)
2. parameters (CSV行)
3. step.variables
4. extract 提取的变量
5. CLI --vars 参数
6. ENV 环境变量          (最高)
```

### 示例

```yaml
config:
  variables:
    username: config_user     # 优先级 1
  parameters:
    - csv:
        path: data/users.csv  # username 列，优先级 2

steps:
  - name: 步骤1
    variables:
      username: step_user     # 优先级 3
    request:
      path: /users/$username  # 实际值: step_user
    extract:
      username: $.data.name   # 优先级 4，假设提取到 extract_user

  - name: 步骤2
    request:
      path: /users/$username  # 实际值: extract_user
```

## 变量引用

### 简单引用

```yaml
path: /users/$userId
```

### 表达式引用

```yaml
path: /users/${userId}
body:
  fullName: ${firstName}_${lastName}
```

### 环境变量

```yaml
# 读取环境变量
base_url: ${ENV(BASE_URL)}

# 带默认值
base_url: ${ENV(BASE_URL, http://localhost:8080)}
```

### 函数调用

```yaml
body:
  uuid: ${uuid()}
  timestamp: ${now()}
  random: ${random_int(1, 100)}
  name: ${fake_name()}
```

### 转义

如果文本中需要包含 `$` 符号，使用 `$$` 转义：

```yaml
body:
  price: $$100  # 实际值: $100
```

## 参数提取（extract）

### JMESPath 语法

Drun 使用 JMESPath 语法提取响应数据。

```yaml
extract:
  # 简单路径
  userId: $.data.id
  
  # 数组索引
  firstItem: $.data.items[0]
  
  # 数组所有元素的某字段
  allIds: $.data.items[*].id
  
  # 数组长度
  itemCount: $.data.items | length(@)
  
  # 嵌套路径
  userName: $.data.user.profile.name
```

### 特殊字段

```yaml
extract:
  # 状态码
  code: $status_code
  
  # 响应时间（毫秒）
  duration: $elapsed_ms
  
  # 响应头
  contentType: $headers.Content-Type
  
  # 完整响应体
  body: $
```

### 提取示例

响应：
```json
{
  "code": 0,
  "data": {
    "token": "eyJhbGc...",
    "user": {
      "id": 12345,
      "name": "张三",
      "roles": ["admin", "user"]
    },
    "items": [
      {"id": 1, "name": "Item1"},
      {"id": 2, "name": "Item2"}
    ]
  }
}
```

提取：
```yaml
extract:
  token: $.data.token           # eyJhbGc...
  userId: $.data.user.id        # 12345
  userName: $.data.user.name    # 张三
  firstRole: $.data.user.roles[0]  # admin
  itemCount: $.data.items | length(@)  # 2
  firstItemId: $.data.items[0].id  # 1
  allItemIds: $.data.items[*].id   # [1, 2]
```

## 变量自动持久化

提取的变量会自动保存到 `.env` 文件，命名规则：

| 原始变量名 | 保存名称 |
|-----------|---------|
| `token` | `TOKEN` |
| `userId` | `USER_ID` |
| `apiKey` | `API_KEY` |
| `accessToken` | `ACCESS_TOKEN` |

### 示例

```yaml
# test_login.yaml
steps:
  - name: 登录
    request:
      method: POST
      path: /api/login
    extract:
      token: $.data.token
      userId: $.data.user.id
```

执行后 `.env` 文件：

```bash
TOKEN=eyJhbGciOiJIUzI1NiIs...
USER_ID=12345
```

### 后续用例直接使用

```yaml
# test_orders.yaml
steps:
  - name: 获取订单
    request:
      method: GET
      path: /api/orders
      headers:
        Authorization: Bearer ${ENV(TOKEN)}
      params:
        user_id: ${ENV(USER_ID)}
```

## 套件内变量传递

在测试套件中，用例间通过内存传递变量，无需文件 I/O。

```yaml
# testsuite_e2e.yaml
config:
  name: E2E 测试流程

caseflow:
  - name: 登录获取 Token
    invoke: test_login
    # 自动导出: token, userId

  - name: 创建订单
    variables:
      user_id: $userId    # 使用前一步骤的变量
    invoke: test_create_order
    # 自动导出: orderId

  - name: 查询订单
    variables:
      order_id: $orderId
    invoke: test_get_order
```

## CSV 导出

将响应数据导出为 CSV 文件。

```yaml
steps:
  - name: 导出用户数据
    request:
      method: GET
      path: /api/users
    export:
      csv:
        data: $.data.users       # 数据路径
        file: data/users.csv     # 输出文件
        columns: [id, name, email]  # 选择列
        mode: overwrite          # overwrite 或 append
```
