# 测试套件

测试套件用于组织和编排多个测试用例，实现复杂的测试流程。

## 基本结构

```yaml
config:
  name: 套件名称
  tags: [smoke, e2e]

caseflow:
  - name: 步骤描述
    invoke: test_case_name
```

## caseflow 语法

### 简单调用

```yaml
config:
  name: 冒烟测试套件

caseflow:
  - name: 健康检查
    invoke: test_health

  - name: 用户登录
    invoke: test_login

  - name: 获取用户信息
    invoke: test_user_info
```

### 带变量传递

```yaml
config:
  name: E2E 测试流程

caseflow:
  - name: 登录获取 Token
    invoke: test_login
    # 执行后自动导出: token, userId

  - name: 创建订单
    variables:
      user_id: $userId      # 使用前一步的变量
    invoke: test_create_order
    # 执行后自动导出: orderId

  - name: 支付订单
    variables:
      order_id: $orderId
      token: $token
    invoke: test_payment

  - name: 验证订单状态
    variables:
      order_id: $orderId
    invoke: test_verify_order
```

### invoke 路径解析

```yaml
caseflow:
  # 简写形式（自动搜索）
  - invoke: test_login           # → testcases/test_login.yaml

  # 带后缀
  - invoke: test_login.yaml      # → testcases/test_login.yaml

  # 指定目录
  - invoke: auth/test_login      # → testcases/auth/test_login.yaml

  # 完整路径
  - invoke: testcases/auth/test_login.yaml
```

搜索顺序：
1. `testcases/` 目录
2. `testsuites/` 目录
3. 当前目录

## 变量传递机制

### 自动导出

被调用用例中通过 `extract` 提取的变量会自动导出到后续步骤：

```yaml
# testcases/test_login.yaml
steps:
  - name: 登录
    request:
      method: POST
      path: /api/login
    extract:
      token: $.data.token      # 自动导出
      userId: $.data.user.id   # 自动导出
```

```yaml
# testsuites/testsuite_e2e.yaml
caseflow:
  - name: 登录
    invoke: test_login
    # token 和 userId 自动可用

  - name: 获取用户
    invoke: test_get_user
    # 可直接使用 $token 和 $userId
```

### 显式传递

通过 `variables` 传递变量给被调用用例：

```yaml
caseflow:
  - name: 创建用户 Alice
    variables:
      username: alice
      email: alice@example.com
    invoke: test_create_user

  - name: 创建用户 Bob
    variables:
      username: bob
      email: bob@example.com
    invoke: test_create_user
```

## 嵌套调用

用例可以嵌套调用其他用例（A → B → C）：

```yaml
# testcases/test_full_auth.yaml
steps:
  - name: 执行登录
    invoke: test_login

  - name: 刷新 Token
    invoke: test_refresh_token

  - name: 验证 Token
    invoke: test_verify_token
```

```yaml
# testsuites/testsuite_auth.yaml
caseflow:
  - name: 完整认证流程
    invoke: test_full_auth     # 会依次执行 login → refresh → verify
```

## Legacy 语法

旧版 `testcases` 语法仍然支持：

```yaml
config:
  name: 测试套件
  base_url: ${ENV(BASE_URL)}

testcases:
  - testcases/test_login.yaml
  - testcases/test_create_order.yaml
  - testcases/test_payment.yaml
```

**区别**：
- `testcases`: 仅支持文件路径列表
- `caseflow`: 支持变量传递、步骤命名等高级功能

## 执行特性

### 顺序执行

套件中的用例严格按顺序执行（从上到下）：

```yaml
caseflow:
  - invoke: step1   # 先执行
  - invoke: step2   # 后执行
  - invoke: step3   # 最后执行
```

### 变量共享

同一套件内的用例通过内存共享变量，无文件 I/O：

```
step1 extract: token → 内存
step2 使用: $token ← 内存
step3 使用: $token ← 内存
```

### 环境变量

套件执行时，`.env` 文件只在启动时读取一次，提取的变量在执行结束后持久化。

## 示例

### 冒烟测试套件

```yaml
# testsuites/testsuite_smoke.yaml
config:
  name: 冒烟测试
  tags: [smoke, critical]

caseflow:
  - name: API 健康检查
    invoke: test_health

  - name: 用户登录
    invoke: test_login

  - name: 基础功能验证
    invoke: test_basic_features
```

### E2E 测试套件

```yaml
# testsuites/testsuite_e2e.yaml
config:
  name: 端到端测试
  tags: [e2e]

caseflow:
  - name: 用户注册
    variables:
      email: ${fake_email()}
    invoke: test_register

  - name: 用户登录
    invoke: test_login

  - name: 创建商品
    invoke: test_create_product

  - name: 添加购物车
    variables:
      product_id: $productId
    invoke: test_add_to_cart

  - name: 创建订单
    invoke: test_create_order

  - name: 支付订单
    variables:
      order_id: $orderId
    invoke: test_payment

  - name: 验证订单完成
    variables:
      order_id: $orderId
    invoke: test_verify_order
```

### 多环境测试套件

```yaml
# testsuites/testsuite_multi_env.yaml
config:
  name: 多环境验证

caseflow:
  - name: 验证开发环境
    variables:
      base_url: https://dev-api.example.com
    invoke: test_env_check

  - name: 验证测试环境
    variables:
      base_url: https://uat-api.example.com
    invoke: test_env_check

  - name: 验证生产环境
    variables:
      base_url: https://api.example.com
    invoke: test_env_check
```

## 运行套件

```bash
# 运行套件
drun r testsuite_smoke --env dev

# 运行套件目录下所有套件
drun r testsuites --env dev

# 带报告
drun r testsuite_e2e --env dev --html reports/e2e.html

# 标签过滤
drun r testsuites --env dev -k "smoke"
```

## 最佳实践

### 1. 套件分层

```
testsuites/
├── testsuite_smoke.yaml       # 冒烟测试（快速验证）
├── testsuite_regression.yaml  # 回归测试（全面覆盖）
├── testsuite_e2e.yaml         # 端到端（业务流程）
└── testsuite_performance.yaml # 性能基线
```

### 2. 用例复用

将原子操作封装为独立用例，在套件中组合：

```yaml
# 登录用例可在多个套件中复用
caseflow:
  - invoke: test_login
```

### 3. 变量命名规范

```yaml
# 使用清晰的变量名
caseflow:
  - name: 创建订单
    invoke: test_create_order
    # 导出: orderId, orderNo

  - name: 支付
    variables:
      order_id: $orderId      # 明确来源
```
