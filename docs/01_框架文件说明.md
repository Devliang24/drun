# Drun 框架文件说明

## 一、框架整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  命令行界面 (CLI)                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  cli.py                                                              │   │
│  │  - drun r test_api --env dev    # 运行测试                           │   │
│  │  - drun init myproject          # 初始化项目                         │   │
│  │  - drun convert sample.curl     # 格式转换                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            核心处理层 (Core Layer)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │   loader/    │───▶│  templating/ │───▶│   runner/    │                  │
│  │  加载器模块   │    │  模板引擎模块 │    │  执行器模块   │                  │
│  └──────────────┘    └──────────────┘    └──────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据模型层 (Model Layer)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│    ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐       │
│    │   Case     │──▶│   Step     │──▶│  Request   │   │  Report    │       │
│    └────────────┘   └────────────┘   └────────────┘   └────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           基础设施层 (Infrastructure)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│    ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐       │
│    │  engine/   │   │ reporter/  │   │ notifier/  │   │   utils/   │       │
│    │ HTTP客户端  │   │  报告生成   │   │  消息通知   │   │  工具函数   │       │
│    └────────────┘   └────────────┘   └────────────┘   └────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 二、目录结构详解

### 2.1 完整目录树

```
drun/
├── __init__.py         # 包初始化，定义版本号 __version__
├── cli.py              # 【核心】命令行入口，使用 typer 框架
├── scorer.py           # 【可选】测试用例质量评分系统
│
├── models/             # 【核心】数据模型层 - Pydantic v2 模型定义
│   ├── __init__.py
│   ├── case.py         # Case 测试用例模型、Suite 套件模型
│   ├── config.py       # Config 配置模型 (base_url, tags, timeout...)
│   ├── step.py         # Step 步骤模型 (request/invoke, extract, validate...)
│   ├── request.py      # StepRequest HTTP 请求模型
│   ├── validators.py   # Validator 断言模型，支持 19 种断言类型
│   └── report.py       # RunReport/CaseResult/StepResult 报告模型
│
├── loader/             # 【核心】加载器层 - 文件解析与发现
│   ├── __init__.py
│   ├── yaml_loader.py  # YAML 文件解析，参数展开(CSV)，模板转义
│   ├── collector.py    # 测试文件发现，标签匹配，invoke 路径解析
│   ├── env.py          # 环境变量加载 (.env.xxx, YAML 环境文件)
│   └── hooks.py        # drun_hooks.py 钩子函数发现和加载
│
├── runner/             # 【核心】执行器层 - 测试执行引擎
│   ├── __init__.py
│   ├── runner.py       # Runner 类 - 测试执行引擎主体 (最复杂)
│   ├── extractors.py   # JMESPath 数据提取 ($.data.id)
│   └── assertions.py   # 断言比较逻辑 (eq, ne, contains, regex 等 19 种)
│
├── engine/             # 【核心】HTTP 引擎
│   ├── __init__.py
│   └── http.py         # HTTPClient - httpx 封装，支持流式响应(SSE)
│
├── templating/         # 【核心】模板引擎 - 变量渲染
│   ├── __init__.py
│   ├── engine.py       # TemplateEngine - ${} 和 $var 变量渲染
│   ├── builtins.py     # 内置函数 (uuid, now, random_int, fake_* 等 17 个)
│   └── context.py      # VarContext 变量上下文管理，支持作用域
│
├── reporter/           # 【核心】报告生成
│   ├── __init__.py
│   ├── html_reporter.py   # HTML 单文件报告，无外部依赖
│   ├── json_reporter.py   # JSON 结构化报告
│   └── allure_reporter.py # Allure 格式报告
│
├── utils/              # 【核心】工具函数
│   ├── __init__.py
│   ├── logging.py      # 统一日志配置，支持文件和控制台输出
│   ├── mask.py         # 敏感信息脱敏 (password, token, secret...)
│   ├── env_writer.py   # 变量持久化到 .env 文件
│   ├── data_exporter.py # CSV 数据导出
│   ├── curl.py         # cURL 命令生成
│   ├── config.py       # 全局配置读取
│   ├── timeit.py       # 计时装饰器
│   └── errors.py       # 自定义异常类 LoadError 等
│
├── notifier/           # 【可选】消息通知
│   ├── __init__.py
│   ├── base.py         # 通知器基类
│   ├── feishu.py       # 飞书 Webhook 通知
│   ├── dingtalk.py     # 钉钉 Webhook 通知
│   ├── emailer.py      # 邮件通知 (SMTP)
│   └── format.py       # 消息格式化工具
│
├── importers/          # 【可选】格式导入
│   ├── __init__.py
│   ├── base.py         # 导入器基类
│   ├── curl.py         # cURL 命令导入
│   ├── postman.py      # Postman Collection v2 导入
│   ├── har.py          # HAR 文件导入
│   └── openapi.py      # OpenAPI/Swagger 规范导入
│
├── exporters/          # 【可选】格式导出
│   ├── __init__.py
│   ├── curl.py         # 导出为 cURL 命令
│   └── snippet.py      # 生成 Shell/Python 代码片段
│
├── scaffolds/          # 【可选】项目脚手架
│   ├── __init__.py
│   └── templates.py    # drun init 项目模板
│
├── server/             # 【可选】Web 报告服务器
│   ├── __init__.py
│   ├── app.py          # FastAPI 应用
│   ├── database.py     # SQLite 报告索引数据库
│   └── scanner.py      # 报告文件扫描器
│
└── db/                 # 【可选】数据库支持
    ├── __init__.py
    ├── database_proxy.py       # MySQL 连接代理
    └── generate_mysql_config.py # MySQL 配置生成
```

### 2.2 各模块详细说明

#### 2.2.1 cli.py - 命令行入口 (约 2200 行)

**文件作用**：整个框架的入口文件，使用 typer 框架实现 CLI

**主要功能**：

| 命令 | 功能 | 示例 |
|------|------|------|
| `drun r` / `drun run` | 运行测试 | `drun r test_login --env dev` |
| `drun init` | 初始化项目 | `drun init myproject --ci` |
| `drun convert` | 格式转换 | `drun convert sample.curl --outfile test.yaml` |
| `drun export curl` | 导出 cURL | `drun export curl test_api.yaml` |
| `drun tags` | 列出标签 | `drun tags testcases/` |
| `drun score` | 质量评分 | `drun score testcases/` |
| `drun check` | 语法检查 | `drun check testcases/` |
| `drun fix` | 自动修复 | `drun fix testcases/` |
| `drun s` / `drun server` | 报告服务器 | `drun s --port 8080` |

**核心函数**：
```python
def _run_impl(...):
    """测试执行的核心实现，约 500 行"""
    # 1. 解析环境文件
    # 2. 发现测试文件
    # 3. 加载用例
    # 4. 标签过滤
    # 5. 执行测试
    # 6. 生成报告
    # 7. 发送通知
```

#### 2.2.2 models/ - 数据模型层

| 文件 | 主要类 | 作用 |
|------|--------|------|
| `case.py` | `Case`, `Suite` | 测试用例和套件的数据结构 |
| `config.py` | `Config` | 配置信息 (name, base_url, tags, timeout, headers...) |
| `step.py` | `Step` | 测试步骤 (name, request/invoke, extract, validate, hooks...) |
| `request.py` | `StepRequest` | HTTP 请求 (method, path, headers, body, params, auth...) |
| `validators.py` | `Validator` | 断言规则 (comparator, check, expect) |
| `report.py` | `RunReport`, `CaseResult`, `StepResult` | 测试报告数据结构 |

#### 2.2.3 loader/ - 加载器层

| 文件 | 主要函数 | 作用 |
|------|----------|------|
| `yaml_loader.py` | `load_yaml_file()`, `expand_parameters()` | YAML 解析，CSV 参数展开 |
| `collector.py` | `discover()`, `match_tags()`, `resolve_invoke_path()` | 文件发现，标签匹配 |
| `env.py` | `load_environment()` | 环境变量加载 |
| `hooks.py` | `find_hooks()`, `get_functions_for()` | 钩子函数加载 |

#### 2.2.4 runner/ - 执行器层

| 文件 | 主要类/函数 | 作用 |
|------|-------------|------|
| `runner.py` | `Runner` 类 | 测试执行引擎，约 1300 行 |
| `extractors.py` | `extract_from_body()` | JMESPath 数据提取 |
| `assertions.py` | `compare()`, `OPS` 字典 | 19 种断言比较函数 |

#### 2.2.5 templating/ - 模板引擎

| 文件 | 主要类/函数 | 作用 |
|------|-------------|------|
| `engine.py` | `TemplateEngine` 类 | 模板渲染，${} 和 $var 语法 |
| `builtins.py` | `BUILTINS` 字典 | 17 个内置函数 |
| `context.py` | `VarContext` 类 | 变量上下文管理 |

## 三、可删除的非核心文件

### 3.1 按功能分类

```
┌─────────────────────────────────────────────────────────────────┐
│                    可安全移除的模块                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 格式导入 (importers/)     - 如不需要从其他工具导入测试用例    │
│     ├── curl.py               约 150 行                         │
│     ├── postman.py            约 200 行                         │
│     ├── har.py                约 180 行                         │
│     └── openapi.py            约 250 行                         │
│                                                                 │
│  2. 格式导出 (exporters/)     - 如不需要生成代码片段             │
│     ├── curl.py               约 120 行                         │
│     └── snippet.py            约 300 行                         │
│                                                                 │
│  3. 消息通知 (notifier/)      - 如不需要测试完成后发送通知       │
│     ├── feishu.py             约 100 行                         │
│     ├── dingtalk.py           约 100 行                         │
│     ├── emailer.py            约 150 行                         │
│     └── format.py             约 80 行                          │
│                                                                 │
│  4. Web服务器 (server/)       - 如不需要在线查看报告             │
│     ├── app.py                约 200 行                         │
│     ├── database.py           约 100 行                         │
│     └── scanner.py            约 80 行                          │
│                                                                 │
│  5. 数据库支持 (db/)          - 如不需要数据库断言               │
│     ├── database_proxy.py     约 150 行                         │
│     └── generate_mysql_config.py 约 50 行                       │
│                                                                 │
│  6. 质量评分 (scorer.py)      - 如不需要测试质量分析             │
│                               约 200 行                         │
│                                                                 │
│  7. 项目脚手架 (scaffolds/)   - 如不需要 drun init 命令          │
│     └── templates.py          约 300 行                         │
│                                                                 │
│  总计可移除: 约 2500 行代码                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 最小化核心 (必须保留)

```
drun/
├── __init__.py
├── cli.py              # 入口 (可精简通知/导入导出相关代码)
├── models/             # 全部保留
├── loader/             # 全部保留
├── runner/             # 全部保留
├── templating/         # 全部保留
├── engine/             # 全部保留
├── reporter/           # 至少保留 html_reporter.py
└── utils/              # 全部保留

最小核心约 6000 行代码
```

## 四、模块依赖关系图

```
                         ┌──────────┐
                         │  cli.py  │ (入口)
                         └────┬─────┘
                              │
         ┌────────────────────┼────────────────────┐
         │                    │                    │
         ▼                    ▼                    ▼
   ┌──────────┐        ┌──────────┐        ┌──────────┐
   │ loader/  │        │ runner/  │        │reporter/ │
   └────┬─────┘        └────┬─────┘        └──────────┘
        │                   │
        │    ┌──────────────┼──────────────┐
        │    │              │              │
        ▼    ▼              ▼              ▼
   ┌──────────┐      ┌──────────┐    ┌──────────┐
   │ models/  │◀─────│templating│    │ engine/  │
   └──────────┘      └──────────┘    └──────────┘
        │                 │               │
        └─────────────────┼───────────────┘
                          ▼
                    ┌──────────┐
                    │  utils/  │
                    └──────────┘
```
