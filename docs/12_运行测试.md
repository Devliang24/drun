# 运行测试

使用 `drun run`（或简写 `drun r`）命令执行测试。

## 基本用法

```bash
# 运行单个测试文件
drun r testcases/test_login.yaml --env dev

# 省略 .yaml 后缀
drun r test_login --env dev

# 运行目录下所有测试
drun r testcases --env dev

# 运行测试套件
drun r testsuite_smoke --env dev
```

## 环境指定（必需）

`--env` 参数是必需的，指定加载哪个环境文件：

```bash
# --env dev → 加载 .env.dev
drun r testcases --env dev

# --env uat → 加载 .env.uat
drun r testcases --env uat

# --env prod → 加载 .env.prod
drun r testcases --env prod
```

环境文件示例：

```bash
# .env.dev
BASE_URL=https://dev-api.example.com
API_KEY=dev-key-xxx

# .env.prod
BASE_URL=https://api.example.com
API_KEY=prod-key-xxx
```

## 标签过滤

使用 `-k` 参数按标签过滤测试用例：

```bash
# 运行包含 smoke 标签的用例
drun r testcases --env dev -k "smoke"

# 布尔表达式
drun r testcases --env dev -k "smoke and api"
drun r testcases --env dev -k "smoke or e2e"
drun r testcases --env dev -k "not slow"
drun r testcases --env dev -k "smoke and not slow"
drun r testcases --env dev -k "(smoke or regression) and not slow"
```

测试用例中的标签定义：

```yaml
config:
  name: 用户登录
  tags: [smoke, auth, critical]
```

## 变量覆盖

使用 `--vars` 参数覆盖变量：

```bash
# 单个变量
drun r test_login --env dev --vars username=admin

# 多个变量
drun r test_login --env dev --vars username=admin --vars password=123456

# 覆盖环境变量
drun r test_login --env dev --vars BASE_URL=http://localhost:8080
```

## 报告生成

```bash
# HTML 报告
drun r testcases --env dev --html reports/report.html

# JSON 报告
drun r testcases --env dev --report reports/results.json

# Allure 报告
drun r testcases --env dev --allure-results allure-results

# 同时生成多种报告
drun r testcases --env dev \
  --html reports/report.html \
  --report reports/results.json \
  --allure-results allure-results
```

## 失败处理

### 快速失败

首次失败时停止执行：

```bash
drun r testcases --env dev --failfast
```

### 重试机制

在用例中配置重试：

```yaml
steps:
  - name: 可能失败的请求
    retry: 3              # 最多重试 3 次
    retry_backoff: 0.5    # 重试间隔（指数退避）
    request:
      method: GET
      path: /api/unstable
```

## 日志控制

```bash
# 日志级别
drun r testcases --env dev --log-level DEBUG
drun r testcases --env dev --log-level INFO
drun r testcases --env dev --log-level WARNING

# 日志文件
drun r testcases --env dev --log-file logs/test.log

# 显示响应头
drun r testcases --env dev --response-headers
```

## 敏感信息处理

```bash
# 脱敏（默认 CI 环境）
drun r testcases --env dev --mask-secrets

# 显示敏感信息（本地调试）
drun r testcases --env dev --reveal-secrets
```

脱敏效果：

```
[REQUEST] Headers:
  Authorization: Bearer ***
  X-API-Key: ***
```

## 代码片段

运行测试时自动生成可执行代码片段：

```bash
# 默认生成 curl 和 python 脚本
drun r test_login --env dev

# 禁用代码片段
drun r test_login --env dev --no-snippet

# 仅生成 curl
drun r test_login --env dev --snippet-lang curl

# 仅生成 python
drun r test_login --env dev --snippet-lang python

# 自定义输出目录
drun r test_login --env dev --snippet-output exports/
```

生成的代码片段：

```bash
# snippets/20250101-120000/step1_login_curl.sh
#!/bin/bash
curl -X POST 'https://api.example.com/api/login' \
  -H 'Content-Type: application/json' \
  -d '{"username": "admin", "password": "123456"}'
```

```python
# snippets/20250101-120000/step1_login_python.py
import httpx

response = httpx.post(
    'https://api.example.com/api/login',
    headers={'Content-Type': 'application/json'},
    json={'username': 'admin', 'password': '123456'}
)
print(response.status_code)
print(response.json())
```

## 消息通知

```bash
# 启用飞书通知
drun r testcases --env dev --notify feishu

# 多渠道通知
drun r testcases --env dev --notify feishu,dingtalk,email

# 仅失败时通知
drun r testcases --env dev --notify feishu --notify-only failed

# 附带 HTML 报告
drun r testcases --env dev --notify email --notify-attach-html
```

通知配置（环境变量）：

```bash
# .env.dev
FEISHU_WEBHOOK=https://open.feishu.cn/open-apis/bot/v2/hook/xxx
DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=xxx
SMTP_HOST=smtp.example.com
SMTP_USER=test@example.com
SMTP_PASS=password
MAIL_TO=team@example.com
```

## 完整示例

### 本地开发调试

```bash
drun r test_login --env dev \
  --log-level DEBUG \
  --reveal-secrets \
  --response-headers
```

### CI/CD 流水线

```bash
drun r testsuites/testsuite_smoke.yaml --env ci \
  --html reports/smoke.html \
  --report reports/smoke.json \
  --mask-secrets \
  --failfast \
  --notify feishu \
  --notify-only failed
```

### 回归测试

```bash
drun r testcases --env uat \
  -k "regression and not slow" \
  --html reports/regression.html \
  --allure-results allure-results
```

## 退出码

| 退出码 | 说明 |
|--------|------|
| 0 | 所有测试通过 |
| 1 | 有测试失败 |
| 2 | 配置错误或文件不存在 |

用于 CI/CD 判断：

```bash
drun r testcases --env ci
if [ $? -eq 0 ]; then
  echo "Tests passed"
else
  echo "Tests failed"
  exit 1
fi
```
