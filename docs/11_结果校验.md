# 结果校验

结果校验（断言）是测试用例的核心，用于验证 API 响应是否符合预期。

## 基本语法

```yaml
validate:
  - comparator: [check, expect]
```

- **comparator**: 比较器名称（如 eq、ne、contains）
- **check**: 检查项（实际值的来源）
- **expect**: 期望值

## 检查项（check）

### 状态码

```yaml
validate:
  - eq: [status_code, 200]
```

### 响应体字段

使用 JMESPath 语法访问 JSON 响应：

```yaml
validate:
  # 简单字段
  - eq: [$.code, 0]
  - eq: [$.data.id, 12345]
  
  # 数组元素
  - eq: [$.data.items[0].name, Item1]
  
  # 数组长度
  - eq: [$.data.items | length(@), 5]
  
  # 嵌套字段
  - eq: [$.data.user.profile.name, 张三]
```

### 响应头

```yaml
validate:
  - eq: [$headers.Content-Type, application/json]
  - contains: [$headers.Content-Type, json]
```

### 响应时间

```yaml
validate:
  - le: [$elapsed_ms, 2000]   # 响应时间 ≤ 2秒
```

### 引用变量

```yaml
validate:
  - eq: [$.data.id, $userId]
  - eq: [$.data.name, ${ENV(EXPECTED_NAME)}]
```

## 内置断言函数

Drun 提供 19 种内置断言函数：

### 相等性断言

| 断言 | 说明 | 示例 |
|------|------|------|
| `eq` | 相等 | `eq: [status_code, 200]` |
| `ne` | 不相等 | `ne: [$.error, null]` |
| `str_eq` | 字符串相等（忽略类型） | `str_eq: [$.id, "123"]` |

### 数值比较

| 断言 | 说明 | 示例 |
|------|------|------|
| `lt` | 小于 | `lt: [$.count, 100]` |
| `le` | 小于等于 | `le: [$.price, 99.99]` |
| `gt` | 大于 | `gt: [$.total, 0]` |
| `ge` | 大于等于 | `ge: [$.age, 18]` |

### 字符串断言

| 断言 | 说明 | 示例 |
|------|------|------|
| `contains` | 包含 | `contains: [$.message, success]` |
| `not_contains` | 不包含 | `not_contains: [$.errors, critical]` |
| `regex` | 正则匹配 | `regex: [$.email, '^[a-z]+@.+$']` |
| `startswith` | 以...开头 | `startswith: [$.url, https://]` |
| `endswith` | 以...结尾 | `endswith: [$.file, .jpg]` |

### 集合断言

| 断言 | 说明 | 示例 |
|------|------|------|
| `in` | 在列表中 | `in: [$.status, [pending, approved]]` |
| `not_in` | 不在列表中 | `not_in: [$.role, [banned, suspended]]` |
| `contains_all` | 包含所有元素 | `contains_all: [$.tags, [api, v1]]` |
| `match_regex_all` | 所有元素匹配正则 | `match_regex_all: [$.emails, '^.+@.+$']` |

### 长度断言

| 断言 | 说明 | 示例 |
|------|------|------|
| `len_eq` | 长度等于 | `len_eq: [$.items, 5]` |
| `len_gt` | 长度大于 | `len_gt: [$.items, 0]` |
| `len_ge` | 长度大于等于 | `len_ge: [$.items, 1]` |
| `len_lt` | 长度小于 | `len_lt: [$.items, 100]` |
| `len_le` | 长度小于等于 | `len_le: [$.items, 50]` |

### 类型断言

| 断言 | 说明 | 示例 |
|------|------|------|
| `type_match` | 类型匹配 | `type_match: [$.data, dict]` |
| `exists` | 存在性 | `exists: [$.data.token, true]` |

## 示例

### 基础断言

```yaml
validate:
  # 状态码
  - eq: [status_code, 200]
  
  # 业务码
  - eq: [$.code, 0]
  
  # 非空
  - ne: [$.data, null]
  
  # 消息包含
  - contains: [$.message, success]
```

### 数组断言

```yaml
validate:
  # 数组非空
  - gt: [$.data.items | length(@), 0]
  
  # 数组长度
  - len_eq: [$.data.items, 10]
  
  # 第一个元素
  - eq: [$.data.items[0].status, active]
  
  # 包含指定元素
  - contains: [$.data.tags, important]
```

### 正则断言

```yaml
validate:
  # 邮箱格式
  - regex: [$.data.email, '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$']
  
  # 手机号格式
  - regex: [$.data.phone, '^1[3-9]\d{9}$']
  
  # UUID 格式
  - regex: [$.data.id, '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$']
  
  # 日期格式
  - regex: [$.data.date, '^\d{4}-\d{2}-\d{2}$']
```

### 性能断言

```yaml
validate:
  # 响应时间 ≤ 2秒
  - le: [$elapsed_ms, 2000]
  
  # 响应时间 ≤ 500ms
  - le: [$elapsed_ms, 500]
```

### 组合断言

```yaml
validate:
  # 成功响应
  - eq: [status_code, 200]
  - eq: [$.code, 0]
  - ne: [$.data, null]
  
  # 用户数据
  - eq: [$.data.user.id, $userId]
  - eq: [$.data.user.status, active]
  - ge: [$.data.user.age, 18]
  
  # 列表数据
  - gt: [$.data.items | length(@), 0]
  - le: [$.data.items | length(@), 100]
```

### 枚举断言

```yaml
validate:
  # 状态在允许范围内
  - in: [$.data.status, [pending, processing, completed, cancelled]]
  
  # 角色不在黑名单中
  - not_in: [$.data.role, [banned, suspended, deleted]]
```

### 类型断言

```yaml
validate:
  # 数据是对象
  - type_match: [$.data, dict]
  
  # items 是数组
  - type_match: [$.data.items, list]
  
  # id 存在
  - exists: [$.data.id, true]
  
  # error 不存在
  - exists: [$.error, false]
```

## 断言失败

当断言失败时，Drun 会记录详细信息：

```
[ASSERT] FAILED: eq [status_code, 200]
  actual: 401
  expect: 200
  
[ASSERT] FAILED: contains [$.message, success]
  actual: "authentication failed"
  expect: "success"
```

## 最佳实践

### 1. 多层次断言

```yaml
validate:
  # 协议层
  - eq: [status_code, 200]
  
  # 业务层
  - eq: [$.code, 0]
  - eq: [$.message, success]
  
  # 数据层
  - ne: [$.data, null]
  - eq: [$.data.id, $expectedId]
```

### 2. 边界检查

```yaml
validate:
  # 数值范围
  - ge: [$.data.price, 0]
  - le: [$.data.price, 99999]
  
  # 字符串长度
  - len_ge: [$.data.name, 1]
  - len_le: [$.data.name, 50]
```

### 3. 格式验证

```yaml
validate:
  # 必填字段非空
  - ne: [$.data.id, null]
  - ne: [$.data.name, ""]
  
  # 格式正确
  - regex: [$.data.email, '^.+@.+\..+$']
```

### 4. 性能基线

```yaml
validate:
  # 核心接口 < 500ms
  - le: [$elapsed_ms, 500]
  
  # 列表接口 < 2s
  - le: [$elapsed_ms, 2000]
```
