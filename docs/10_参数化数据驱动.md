# 参数化数据驱动

参数化允许使用外部数据（CSV）驱动测试执行，实现一套用例多组数据的批量测试。

## CSV 参数化

### 基本用法

**data/users.csv**

```csv
username,email,role
alice,alice@example.com,admin
bob,bob@example.com,user
carol,carol@example.com,guest
```

**testcases/test_register.yaml**

```yaml
config:
  name: 批量用户注册
  parameters:
    - csv:
        path: data/users.csv

steps:
  - name: 注册 $username
    request:
      method: POST
      path: /api/register
      body:
        username: $username
        email: $email
        role: $role
    validate:
      - eq: [status_code, 201]
      - eq: [$.data.username, $username]
      - eq: [$.data.email, $email]
```

Drun 会执行 3 次测试（每行数据一次）。

### CSV 配置选项

```yaml
config:
  parameters:
    - csv:
        path: data/users.csv    # CSV 文件路径
        strip: true             # 去除空格（默认 true）
        encoding: utf-8         # 文件编码（默认 utf-8）
```

### 运行输出

```
[CASE] Start: 批量用户注册 | params={'username': 'alice', 'email': 'alice@example.com', 'role': 'admin'}
[STEP] 注册 alice | status=passed
[CASE] Start: 批量用户注册 | params={'username': 'bob', 'email': 'bob@example.com', 'role': 'user'}
[STEP] 注册 bob | status=passed
[CASE] Start: 批量用户注册 | params={'username': 'carol', 'email': 'carol@example.com', 'role': 'guest'}
[STEP] 注册 carol | status=passed
```

## 多列数据

### 复杂数据示例

**data/login_cases.csv**

```csv
case_desc,username,password,expected_code,expected_msg
正确密码,admin,admin123,200,success
错误密码,admin,wrong,401,invalid password
用户不存在,nouser,123456,404,user not found
空密码,admin,,400,password required
```

**testcases/test_login_cases.yaml**

```yaml
config:
  name: 登录场景测试
  parameters:
    - csv:
        path: data/login_cases.csv

steps:
  - name: "场景: $case_desc"
    request:
      method: POST
      path: /api/login
      body:
        username: $username
        password: $password
    validate:
      - eq: [status_code, $expected_code]
      - contains: [$.message, $expected_msg]
```

## 与变量结合

参数化变量可以与其他变量来源结合使用：

```yaml
config:
  name: 用户 CRUD 测试
  base_url: ${ENV(BASE_URL)}
  variables:
    apiVersion: v1
  parameters:
    - csv:
        path: data/users.csv

steps:
  - name: 创建 $username
    request:
      method: POST
      path: /api/$apiVersion/users  # 使用全局变量
      headers:
        Authorization: Bearer ${ENV(TOKEN)}  # 使用环境变量
      body:
        username: $username    # 使用参数化变量
        email: $email
```

## 变量优先级

当参数化变量与其他变量同名时，优先级如下：

```
1. config.variables      (最低)
2. parameters (CSV行)    ← 参数化在这里
3. step.variables
4. extract 提取的变量
5. CLI --vars 参数
6. ENV 环境变量          (最高)
```

### 覆盖示例

```yaml
config:
  variables:
    username: default_user     # 会被 CSV 覆盖
  parameters:
    - csv:
        path: data/users.csv   # username 列

steps:
  - name: 创建 $username
    request:
      path: /users
      body:
        username: $username    # 实际使用 CSV 中的值
```

## 数据文件路径

### 相对路径

```yaml
# 相对于测试文件位置
parameters:
  - csv:
      path: data/users.csv

# 相对于项目根目录
parameters:
  - csv:
      path: ./data/users.csv
```

### 绝对路径

```yaml
parameters:
  - csv:
      path: /path/to/data/users.csv
```

## 空值处理

CSV 中的空值会被解析为空字符串：

```csv
username,email,role
alice,alice@example.com,admin
bob,,user
```

```yaml
# bob 的 email 为空字符串 ""
steps:
  - name: 创建用户
    request:
      body:
        username: $username
        email: $email          # bob 时为 ""
        role: $role
```

## 最佳实践

### 1. 数据文件组织

```
data/
├── users.csv           # 用户数据
├── products.csv        # 产品数据
├── login_cases.csv     # 登录测试用例
└── orders/
    ├── create.csv      # 创建订单数据
    └── update.csv      # 更新订单数据
```

### 2. 使用描述列

在 CSV 中添加描述列，便于理解测试场景：

```csv
desc,input,expected
正常值,100,success
边界值最小,0,success
边界值最大,9999,success
负数,−1,error
```

### 3. 数据与用例分离

将测试数据和测试逻辑分开维护：

```yaml
# 用例只关注逻辑
config:
  parameters:
    - csv:
        path: data/test_data.csv

steps:
  - name: "$desc"
    request:
      body:
        value: $input
    validate:
      - eq: [$.status, $expected]
```

### 4. 避免过多参数化

参数化数据过多会导致执行时间过长，建议：

- 冒烟测试：3-5 组核心数据
- 功能测试：10-20 组边界数据
- 压力测试：使用专门的性能测试工具

## 示例：登录场景全覆盖

**data/login_scenarios.csv**

```csv
scenario,username,password,code,message
正常登录,admin,admin123,200,登录成功
密码错误,admin,wrong,401,密码错误
用户不存在,unknown,123456,404,用户不存在
用户名为空,,admin123,400,用户名不能为空
密码为空,admin,,400,密码不能为空
用户名特殊字符,admin<script>,123456,400,用户名格式错误
密码过短,admin,123,400,密码长度不足
账号锁定,locked,admin123,403,账号已锁定
```

**testcases/test_login_all.yaml**

```yaml
config:
  name: 登录接口全场景测试
  base_url: ${ENV(BASE_URL)}
  tags: [login, regression]
  parameters:
    - csv:
        path: data/login_scenarios.csv

steps:
  - name: "$scenario"
    request:
      method: POST
      path: /api/login
      body:
        username: $username
        password: $password
    validate:
      - eq: [status_code, $code]
      - contains: [$.message, $message]
```
