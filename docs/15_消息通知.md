# 消息通知

Drun 支持在测试完成后发送通知，适用于 CI/CD 场景。

## 支持的渠道

- **飞书（Feishu）**：Webhook 机器人
- **钉钉（DingTalk）**：Webhook 机器人
- **邮件（Email）**：SMTP 发送

## 启用通知

```bash
# 单渠道
drun r testcases --env dev --notify feishu

# 多渠道
drun r testcases --env dev --notify feishu,dingtalk,email

# 仅失败时通知
drun r testcases --env dev --notify feishu --notify-only failed

# 仅通过时通知
drun r testcases --env dev --notify feishu --notify-only passed

# 始终通知
drun r testcases --env dev --notify feishu --notify-only always
```

## 飞书通知

### 配置

在环境文件中添加：

```bash
# .env.dev
FEISHU_WEBHOOK=https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx
FEISHU_STYLE=card    # 可选: card 或 text
FEISHU_MENTION=@all  # 可选: @all 或 @user1,@user2
```

### 获取 Webhook

1. 打开飞书群设置
2. 添加机器人 → 自定义机器人
3. 复制 Webhook 地址

### 通知样式

**Card 样式（默认）**：

```
┌─────────────────────────────────────────┐
│  API 测试报告                           │
├─────────────────────────────────────────┤
│  环境: dev                              │
│  状态: ❌ 失败                          │
│  通过: 8 / 10                           │
│  耗时: 5.2s                             │
├─────────────────────────────────────────┤
│  失败用例:                              │
│  • 订单创建测试                         │
│  • 支付测试                             │
└─────────────────────────────────────────┘
```

**Text 样式**：

```
[API测试] 环境:dev 状态:失败 通过:8/10 耗时:5.2s
失败: 订单创建测试, 支付测试
```

## 钉钉通知

### 配置

```bash
# .env.dev
DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxx
DINGTALK_STYLE=markdown    # 可选: markdown 或 text
DINGTALK_AT_MOBILES=13800138000,13900139000  # @指定人
DINGTALK_AT_ALL=false      # 是否@所有人
DINGTALK_SECRET=SECxxxxxxxx  # 加签密钥（可选）
```

### 获取 Webhook

1. 打开钉钉群设置
2. 智能群助手 → 添加机器人 → 自定义
3. 选择安全设置（关键词/加签/IP白名单）
4. 复制 Webhook 地址

### 加签配置

如果启用了加签验证：

```bash
DINGTALK_SECRET=SEC1234567890abcdef...
```

### 通知样式

**Markdown 样式（默认）**：

```markdown
### API 测试报告

**环境**: dev  
**状态**: ❌ 失败  
**通过**: 8 / 10  
**耗时**: 5.2s  

#### 失败用例
- 订单创建测试
- 支付测试
```

## 邮件通知

### 配置

```bash
# .env.dev
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=test@example.com
SMTP_PASS=your-password
SMTP_SSL=true           # 是否使用 SSL
MAIL_FROM=test@example.com
MAIL_TO=team@example.com,manager@example.com
NOTIFY_ATTACH_HTML=true # 附带 HTML 报告
```

### 常用 SMTP 配置

**Gmail**：
```bash
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SSL=true
```

**163 邮箱**：
```bash
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SMTP_SSL=true
```

**QQ 邮箱**：
```bash
SMTP_HOST=smtp.qq.com
SMTP_PORT=465
SMTP_SSL=true
```

### 邮件内容

```
主题: [API测试] 环境:dev 状态:失败 通过:8/10

正文:
API 测试报告

环境: dev
状态: 失败
通过: 8 / 10
耗时: 5.2s

失败用例:
• 订单创建测试
• 支付测试

附件: report.html（如启用）
```

## 通知策略

### notify-only 选项

| 值 | 说明 |
|----|------|
| `always` | 始终发送通知 |
| `failed` | 仅测试失败时发送 |
| `passed` | 仅测试通过时发送 |

```bash
# 仅失败时通知（推荐 CI/CD 使用）
drun r testcases --env ci --notify feishu --notify-only failed
```

### 自动检测

如果配置了 Webhook/SMTP，未指定 `--notify` 时会自动启用：

```bash
# .env 中配置了 FEISHU_WEBHOOK
# 以下命令会自动发送飞书通知
drun r testcases --env dev
```

## CI/CD 集成

### GitHub Actions

```yaml
- name: Run Tests
  run: |
    drun r testsuites/testsuite_smoke.yaml --env ci \
      --html reports/report.html \
      --notify feishu \
      --notify-only failed
  env:
    FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
```

### Jenkins

```groovy
environment {
    FEISHU_WEBHOOK = credentials('feishu-webhook')
    DINGTALK_WEBHOOK = credentials('dingtalk-webhook')
}

stage('Test') {
    steps {
        sh '''
            drun r testcases --env ci \
              --notify feishu,dingtalk \
              --notify-only failed
        '''
    }
}
```

## 通知内容定制

### 环境变量

通知中会包含以下信息：

- **SYSTEM_NAME** 或 **PROJECT_NAME**：项目名称
- 环境名称（--env 参数）
- 测试结果统计
- 失败用例列表
- 执行耗时

### 自定义项目名

```bash
# .env.dev
SYSTEM_NAME=订单系统
# 或
PROJECT_NAME=Order Service
```

通知显示：

```
[订单系统] API测试 环境:dev 状态:失败
```

## 故障排查

### 飞书通知失败

1. 检查 Webhook 地址是否正确
2. 检查机器人是否被禁用
3. 检查网络是否可访问飞书服务器

### 钉钉通知失败

1. 检查安全设置（关键词/加签/IP）
2. 检查 Webhook 地址是否正确
3. 如使用加签，确认 SECRET 正确

### 邮件发送失败

1. 检查 SMTP 配置是否正确
2. 检查密码（可能需要应用专用密码）
3. 检查发件人是否被允许
4. 检查网络是否可访问 SMTP 服务器

### 调试方式

```bash
# 启用 DEBUG 日志查看详情
drun r testcases --env dev --notify feishu --log-level DEBUG
```
