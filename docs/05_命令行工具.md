# 命令行工具

安装 Drun 后，你将获得 `drun` 命令行工具。

## 命令概览

```bash
$ drun --help

Commands:
  r / run          运行测试用例
  init             初始化测试项目
  convert          格式转换（cURL/HAR/Postman）
  convert-openapi  OpenAPI 转换
  export curl      导出为 cURL
  tags             列出标签
  score            质量评分
  check            语法检查
  fix              自动修复
  s / server       报告服务器
```

## drun run（运行测试）

运行测试用例，`r` 是 `run` 的简写。

### 基本用法

```bash
# 运行单个测试（支持省略 .yaml 后缀）
drun r test_login --env dev
drun r testcases/test_login.yaml --env dev

# 运行目录下所有测试
drun r testcases --env dev

# 运行测试套件
drun r testsuite_smoke --env dev
```

### 常用参数

```bash
drun r <path> --env <name> [OPTIONS]

必需参数:
  --env NAME            环境名称，加载 .env.<name> 文件

可选参数:
  -k TAG_EXPR           标签过滤表达式
  --vars k=v            覆盖变量（可多次使用）
  --html FILE           生成 HTML 报告
  --report FILE         生成 JSON 报告
  --allure-results DIR  生成 Allure 结果
  --failfast            首次失败时停止
  --mask-secrets        脱敏敏感信息
  --reveal-secrets      显示敏感信息
  --response-headers    记录响应头
  --log-level LEVEL     日志级别（DEBUG/INFO/WARNING/ERROR）
  --log-file FILE       日志文件
  --notify CHANNELS     通知渠道（feishu,dingtalk,email）
  --notify-only POLICY  通知策略（always/failed/passed）
  --no-snippet          禁用代码片段生成
  --snippet-lang LANG   片段语言（all/curl/python）
```

### 示例

```bash
# 带 HTML 报告
drun r testcases --env dev --html reports/report.html

# 标签过滤
drun r testcases --env dev -k "smoke and not slow"

# 覆盖变量
drun r test_login --env dev --vars username=admin --vars password=123456

# 调试模式
drun r test_login --env dev --log-level DEBUG --reveal-secrets

# 快速失败
drun r testcases --env dev --failfast

# 发送通知
drun r testcases --env dev --notify feishu --notify-only failed
```

## drun init（初始化项目）

创建脚手架项目。

```bash
# 基础模式
drun init myproject

# 包含 CI 工作流
drun init myproject --ci

# 强制覆盖
drun init myproject --force
```

## drun convert（格式转换）

从其他格式转换为 YAML 测试用例。

### cURL 转换

```bash
# 基本转换
drun convert sample.curl --outfile testcases/from_curl.yaml

# 脱敏敏感头
drun convert sample.curl --outfile test.yaml --redact Authorization,Cookie

# 提取为变量
drun convert sample.curl --outfile test.yaml --placeholders
```

### Postman 转换

```bash
# 转换 Collection
drun convert collection.json --outfile testcases/from_postman.yaml

# 带环境文件
drun convert collection.json --outfile test.yaml --postman-env environment.json

# 拆分为多文件
drun convert collection.json --split-output --suite-out testsuites/suite.yaml
```

### HAR 转换

```bash
# 基本转换
drun convert recording.har --outfile testcases/from_har.yaml

# 仅保留 2xx 响应
drun convert recording.har --outfile test.yaml --only-2xx

# 排除静态资源
drun convert recording.har --outfile test.yaml --exclude-static
```

## drun convert-openapi（OpenAPI 转换）

```bash
# 基本转换
drun convert-openapi openapi.json --outfile testcases/from_openapi.yaml

# 按标签过滤
drun convert-openapi openapi.json --outfile test.yaml --tags users,orders

# 拆分输出
drun convert-openapi openapi.json --split-output --placeholders
```

## drun export curl（导出 cURL）

将测试用例导出为 cURL 命令。

```bash
# 基本导出
drun export curl testcases/test_api.yaml

# 指定步骤
drun export curl test_api.yaml --steps 1,3-5

# 输出到文件
drun export curl test_api.yaml --outfile export.curl

# 添加注释
drun export curl test_api.yaml --with-comments

# 脱敏
drun export curl test_api.yaml --redact Authorization
```

## drun tags（列出标签）

```bash
$ drun tags testcases/

Cases scanned: 5
Tags:
- smoke: 3 cases
- api: 2 cases
- e2e: 1 case
```

## drun score（质量评分）

评估测试用例质量。

```bash
$ drun score testcases/

┌─────────────────────────┬───────┬───────┬───────┬─────────────────────────┐
│ Case                    │ Score │ Grade │ Steps │ Issues                  │
├─────────────────────────┼───────┼───────┼───────┼─────────────────────────┤
│ 用户登录测试            │ 85    │ B     │ 3     │ Add retry mechanism     │
│ 订单创建测试            │ 72    │ B     │ 5     │ Add more assertions     │
│ 健康检查                │ 45    │ D     │ 1     │ Missing extract; ...    │
└─────────────────────────┴───────┴───────┴───────┴─────────────────────────┘

Average: 67 (C)
Total cases: 3
```

### 评分维度

| 级别 | 维度 | 权重 | 说明 |
|------|------|------|------|
| Step | Assertions | 50% | 断言数量 |
| Step | Extraction | 30% | 变量提取 |
| Step | Retry | 20% | 重试机制 |
| Case | Parameters | 50% | 参数化 |
| Case | Hooks | 30% | 钩子使用 |
| Case | Reuse | 20% | 用例复用 |

### 评分等级

- **A** (90+): 优秀 - 绿色
- **B** (70-89): 良好 - 蓝色
- **C** (50-69): 一般 - 黄色
- **D** (<50): 待改进 - 红色

## drun check（语法检查）

```bash
$ drun check testcases/

[OK] testcases/test_login.yaml
[WARN] testcases/test_users.yaml: Missing tags
[ERROR] testcases/test_orders.yaml: Invalid validator 'eqq'
```

## drun fix（自动修复）

```bash
# 修复所有问题
drun fix testcases/

# 仅修复缩进
drun fix testcases/ --only-spacing

# 仅修复 hooks 格式
drun fix testcases/ --only-hooks
```

## drun server（报告服务器）

启动 Web 报告服务器，`s` 是 `server` 的简写。

```bash
# 默认启动
drun s

# 指定端口
drun s --port 8080

# 不自动打开浏览器
drun s --no-open

# 开发模式（自动重载）
drun s --reload
```

功能：
- 自动扫描 `reports/` 目录
- SQLite 报告索引
- 分页列表（每页 18 条）
- 详情查看
- RESTful API: `/api/reports`
